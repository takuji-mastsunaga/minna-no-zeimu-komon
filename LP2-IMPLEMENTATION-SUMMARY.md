# LP2実装サマリー

## 📋 概要

このドキュメントは、LP2（詳細情報入力ページ）の実装に関する全体のサマリーです。

---

## 🎯 LP2の目的

決済完了後、税務顧問サービスに必要な詳細情報を顧客から収集するためのページ。

---

## 📚 関連ドキュメント

1. **[LP2-DESIGN-SPEC.md](LP2-DESIGN-SPEC.md)**: LP2の全体設計書
2. **[LP2-GAS-API-SPEC.md](LP2-GAS-API-SPEC.md)**: GAS API詳細設計書
3. **[LP2-SPREADSHEET-COLUMNS.md](LP2-SPREADSHEET-COLUMNS.md)**: スプレッドシート列定義書
4. **このファイル**: 実装サマリー

---

## 🔄 システムフロー（全体）

```
┌─────────────┐
│   LP1開始   │ ユーザーが基本情報を入力
└──────┬──────┘
       │
       ▼
┌─────────────────────┐
│ pending_applications │ 一時保存
│  シートに保存        │
└──────┬──────────────┘
       │
       ▼
┌──────────────┐
│ Stripe決済   │ ユーザーがStripe Checkoutで決済
└──────┬───────┘
       │
       ▼ ✅ 決済完了
┌─────────────────────┐
│ Webhook受信         │
│ checkout.session.   │
│ completed           │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│ moveFromPending     │ pending → master へ移動
│ ToMaster()          │ 決済情報（AC-AF列）を保存
└──────┬──────────────┘
       │
       ├─────────────────────────┐
       │                         │
       ▼                         ▼
┌──────────────┐      ┌──────────────┐
│ LP2リダイレ  │      │ LP2案内メール │
│ クト         │      │ 送信          │
│（success_url)│      │ sendLP2Email()│
└──────┬───────┘      └──────┬───────┘
       │                     │
       └─────────┬───────────┘
                 │
                 ▼
         ┌──────────────┐
         │ ユーザーがLP2│
         │ にアクセス   │
         └──────┬───────┘
                │
                ▼
         ┌──────────────┐
         │ 簡易認証     │ メールアドレスの
         │（3回まで）   │ 最初の3文字入力
         └──────┬───────┘
                │
                ▼ ✅ 認証成功
         ┌──────────────┐
         │ LP2フォーム  │ 個人/法人を
         │ 表示         │ 自動判定
         └──────┬───────┘
                │
                ▼
         ┌──────────────┐
         │ 詳細情報入力 │ ユーザーが
         │              │ 詳細情報を入力
         └──────┬───────┘
                │
                ▼
         ┌──────────────┐
         │ 送信         │ saveLP2Data()
         └──────┬───────┘
                │
                ▼
         ┌──────────────────┐
         │ masterシート     │ AG-AW列に保存
         │ AG-AW列に保存    │ AV列: TRUE
         │                  │ AW列: 日時
         └──────┬───────────┘
                │
                ▼
         ┌──────────────┐
         │ 入力完了表示 │
         └──────────────┘
```

---

## 🛠️ 実装コンポーネント

### 1. フロントエンド

#### ファイル
- `lp2-detail.html`（新規作成）

#### 主要機能
1. **認証モーダル**
   - メールアドレスの最初の3文字を入力
   - 3回まで試行可能
   - 失敗時はエラーメッセージ表示

2. **フォーム表示**
   - 個人/法人を自動判定
   - entityTypeに応じて適切なフォームを表示

3. **入力バリデーション**
   - リアルタイムバリデーション
   - 送信前の全項目チェック

4. **入力済み表示**
   - 既にLP2を入力済みの場合、編集不可メッセージを表示

#### API呼び出し
- `authenticateLP2`: 認証
- `getLP2FormData`: フォームデータ取得
- `saveLP2Data`: データ保存

---

### 2. バックエンド（GAS）

#### 新規関数

##### authenticateLP2(sessionId, emailPrefix)
- **目的**: LP2アクセス時の簡易認証
- **処理**: session_id → UUID → メールアドレスの最初の3文字を照合
- **戻り値**: 認証成功/失敗、entityType

##### getLP2FormData(sessionId)
- **目的**: LP2フォーム表示用データ取得
- **処理**: session_id → UUID → LP2入力完了フラグをチェック
- **戻り値**: 入力済み/未入力、entityType、既存データ

##### saveLP2Data(sessionId, data)
- **目的**: LP2で入力された詳細情報を保存
- **処理**: 
  1. LP2入力完了フラグをチェック
  2. AG-AU列にデータを保存
  3. AV列にTRUEを設定
  4. AW列に日時を記録
- **戻り値**: 成功/失敗

##### sendLP2Email(uuid, sessionId)
- **目的**: LP2案内メールを送信
- **処理**: 
  1. UUID → masterシートから顧客情報取得
  2. メール本文を作成
  3. GmailAppでメール送信
- **戻り値**: 成功/失敗

#### 補助関数
- `getUuidBySessionId_(sessionId)`: Session IDからUUIDを取得
- `extractLP2Data_(rowData, entityType)`: AG-AU列のデータを抽出
- `buildLP2Values_(data, entityType)`: LP2データを列の配列に変換
- `buildLP2EmailBody_(fullName, lp2Url)`: LP2案内メール本文を作成

#### 既存関数の修正
- `handleCheckoutCompleted()`: LP2案内メール送信処理を追加

---

### 3. データベース（Google Sheets）

#### masterシート 新規列（AG-AW）

| 列 | 列名 | 個人 | 法人 |
|----|------|------|------|
| AG | 法人名 | 空欄 | ✅ |
| AH | 法人郵便番号 | 空欄 | ✅ |
| AI | 法人住所 | 空欄 | ✅ |
| AJ | 代表者名/名前 | ✅ | ✅ |
| AK | フリガナ | ✅ | ✅ |
| AL | 代表者郵便番号/郵便番号 | ✅ | ✅ |
| AM | 代表者住所/住所 | ✅ | ✅ |
| AN | e-tax利用者識別番号 | ✅ | ✅ |
| AO | e-tax暗証番号/パスワード | ✅ | ✅ |
| AP | e-Ltax利用者ID | 空欄 | ✅ |
| AQ | e-Ltax暗証番号 | 空欄 | ✅ |
| AR | 会計ソフト使用状況 | ✅ | ✅ |
| AS | 使用会計ソフト名 | 条件付き | 条件付き |
| AT | その他会計ソフト名 | 条件付き | 条件付き |
| AU | クラウド会計メールアドレス | ✅ | ✅ |
| AV | LP2入力完了フラグ | 自動 | 自動 |
| AW | LP2入力日時 | 自動 | 自動 |

---

## 🔐 セキュリティ

### 認証
- **簡易認証**: メールアドレスの最初の3文字
- **試行回数制限**: 3回まで
- **失敗時**: 「minzei@solvis-group.comまでお問い合わせください」

### データ保護
1. **再編集防止**: AV列（LP2入力完了フラグ）でチェック
2. **URLパラメータ**: session_id（Stripe提供の一意なID）
3. **HTTPS**: Vercelで自動的にHTTPS化

### 注意事項
- **パスワード**: AO列、AQ列は平文で保存されます
- **アクセス管理**: スプレッドシートのアクセス権限を厳密に管理

---

## 📧 メール送信

### 送信タイミング
- Stripe Webhook（`checkout.session.completed`）処理後
- `moveFromPendingToMaster`完了時

### メール内容
- **件名**: 【みんなの税務顧問】お申し込みありがとうございます - 詳細情報のご入力をお願いいたします
- **本文**: 
  - 決済完了の確認
  - LP2のリンク（session_id付き）
  - 注意事項（リンクは専用、一度入力すると変更不可）
  - 今後の流れ

### 変数
- `{お名前}`: masterシートのC列（姓）+ D列（名）
- `{LP2のURL}`: `LP2_BASE_URL + '?session_id=' + sessionId`

---

## 🧪 テスト項目

### 正常系
1. ✅ 決済完了後、LP2にリダイレクトされる
2. ✅ LP2案内メールが送信される
3. ✅ メール内のリンクからLP2にアクセスできる
4. ✅ 認証モーダルで正しい3文字を入力すると、フォームが表示される
5. ✅ 個人の場合、個人用フォームが表示される
6. ✅ 法人の場合、法人用フォームが表示される
7. ✅ すべての必須項目を入力して送信すると、成功メッセージが表示される
8. ✅ Google Sheetsの該当行のAG-AW列にデータが保存される
9. ✅ AV列がTRUE、AW列に日時が記録される
10. ✅ 再度アクセスすると、「入力済み」メッセージが表示される

### 異常系
1. ❌ 認証で間違った3文字を入力すると、エラーメッセージが表示される
2. ❌ 認証で3回失敗すると、入力不可になる
3. ❌ 必須項目が未入力の場合、バリデーションエラーが表示される
4. ❌ 既に入力済みのデータを再送信しようとすると、エラーが返る
5. ❌ 無効なsession_idでアクセスすると、エラーメッセージが表示される
6. ❌ メール送信が失敗しても、決済データは保存される（ログに記録）

---

## 📦 実装チェックリスト

### フェーズ1: バックエンド実装

- [ ] 1. `Code.gs`に新規関数を追加
  - [ ] `authenticateLP2()`
  - [ ] `getLP2FormData()`
  - [ ] `saveLP2Data()`
  - [ ] `sendLP2Email()`
  - [ ] 補助関数すべて

- [ ] 2. 既存関数を修正
  - [ ] `handleCheckoutCompleted()` にメール送信処理を追加

- [ ] 3. 定数を追加
  - [ ] `LP2_BASE_URL` を追加

- [ ] 4. GASデプロイ
  - [ ] 「新しいデプロイ」を実行
  - [ ] バージョン説明: `v23 - LP2機能追加`
  - [ ] デプロイIDを記録

- [ ] 5. テスト
  - [ ] `testAuthenticateLP2()` 実行
  - [ ] `testGetLP2FormData()` 実行
  - [ ] `testSaveLP2DataIndividual()` 実行
  - [ ] `testSaveLP2DataCorporate()` 実行
  - [ ] `testSendLP2Email()` 実行

---

### フェーズ2: スプレッドシート設定

- [ ] 1. masterシートにヘッダー追加
  - [ ] AG列: 法人名
  - [ ] AH列: 法人郵便番号
  - [ ] AI列: 法人住所
  - [ ] AJ列: 代表者名/名前
  - [ ] AK列: フリガナ
  - [ ] AL列: 代表者郵便番号/郵便番号
  - [ ] AM列: 代表者住所/住所
  - [ ] AN列: e-tax利用者識別番号
  - [ ] AO列: e-tax暗証番号/パスワード
  - [ ] AP列: e-Ltax利用者ID
  - [ ] AQ列: e-Ltax暗証番号
  - [ ] AR列: 会計ソフト使用状況
  - [ ] AS列: 使用会計ソフト名
  - [ ] AT列: その他会計ソフト名
  - [ ] AU列: クラウド会計メールアドレス
  - [ ] AV列: LP2入力完了フラグ
  - [ ] AW列: LP2入力日時

- [ ] 2. （オプション）データ検証ルールを設定
  - [ ] AR列: リストから選択（使用している/使用していない）
  - [ ] AS列: リストから選択（マネーフォワード/freee/その他）
  - [ ] AV列: チェックボックス

---

### フェーズ3: フロントエンド実装

- [ ] 1. `lp2-detail.html`を作成
  - [ ] 認証モーダル実装
  - [ ] 個人フォーム実装
  - [ ] 法人フォーム実装
  - [ ] バリデーション実装
  - [ ] 入力済み表示実装

- [ ] 2. GAS_API_URL を設定
  - [ ] 最新のGASデプロイID（v23）を使用

- [ ] 3. Vercelにデプロイ
  - [ ] `lp2-detail.html`をアップロード
  - [ ] デプロイ実行
  - [ ] デプロイURLを記録

- [ ] 4. Code.gs の LP2_BASE_URL を更新
  - [ ] 最新のVercel URLに更新
  - [ ] GASを再デプロイ（v24）

---

### フェーズ4: Stripe設定更新

- [ ] 1. Stripe Checkoutの success_url を更新
  - [ ] `createStripeCheckoutSession()` の `success_url` を LP2 URL に変更
  - [ ] `?session_id={CHECKOUT_SESSION_ID}` を追加

---

### フェーズ5: 統合テスト

- [ ] 1. 個人プランで決済テスト
  - [ ] LP1入力 → 決済 → LP2リダイレクト
  - [ ] LP2案内メール受信
  - [ ] LP2認証（3文字入力）
  - [ ] 個人フォーム表示
  - [ ] 詳細情報入力・送信
  - [ ] Google Sheets確認（AG-AW列）
  - [ ] 再アクセスで「入力済み」表示

- [ ] 2. 法人プランで決済テスト
  - [ ] LP1入力 → 決済 → LP2リダイレクト
  - [ ] LP2案内メール受信
  - [ ] LP2認証（3文字入力）
  - [ ] 法人フォーム表示
  - [ ] 詳細情報入力・送信
  - [ ] Google Sheets確認（AG-AW列）
  - [ ] 再アクセスで「入力済み」表示

- [ ] 3. 異常系テスト
  - [ ] 認証失敗（3回）
  - [ ] 無効なsession_id
  - [ ] 入力済みデータの再送信
  - [ ] バリデーションエラー

---

## 🚀 デプロイ手順（詳細）

### ステップ1: GAS実装
1. `gas-backend/Code.gs`を開く
2. 新規関数をコピー&ペースト
3. 既存関数を修正
4. `LP2_BASE_URL`定数を追加
5. 保存

### ステップ2: GASデプロイ
1. 「デプロイ」→「新しいデプロイ」
2. 説明: `v23 - LP2機能追加（認証、フォーム、メール送信）`
3. デプロイ実行
4. デプロイID（例: `AKfycbw...`）をコピー

### ステップ3: スプレッドシート設定
1. Google Sheetsを開く
2. masterシートのAG-AW列にヘッダーを追加
3. （オプション）データ検証ルールを設定

### ステップ4: フロントエンド実装
1. `lp2-detail.html`を作成
2. GAS_API_URLに最新のデプロイID（v23）を設定
3. Vercelにデプロイ
4. デプロイURL（例: `https://minna-no-zeimu-komon-xxx.vercel.app/lp2-detail.html`）をコピー

### ステップ5: GAS定数更新
1. `Code.gs`の`LP2_BASE_URL`を最新のVercel URLに更新
2. GASを再デプロイ（v24）
3. デプロイID（v24）をコピー

### ステップ6: フロントエンド URL更新
1. `1218tst.html`の`GAS_API_URL`を最新のデプロイID（v24）に更新
2. `lp2-success.html`（既存）の`GAS_API_URL`を最新のデプロイID（v24）に更新
3. `lp2-detail.html`の`GAS_API_URL`を最新のデプロイID（v24）に更新
4. Vercelに再デプロイ

### ステップ7: Stripe設定更新
1. `Code.gs`の`createStripeCheckoutSession()`を修正
   - `success_url`を`LP2_BASE_URL + '?session_id=' + sessionId`に変更
2. GASを再デプロイ（v25）
3. デプロイID（v25）をコピー
4. フロントエンドの`GAS_API_URL`をv25に更新
5. Vercelに再デプロイ

### ステップ8: 統合テスト
1. 個人プランで決済テスト実行
2. 法人プランで決済テスト実行
3. 異常系テスト実行

---

## 📝 備考

### 運用上の注意点
1. **再編集の要望**: 顧客から再編集の要望があった場合、管理者がAV列をFALSEに変更することで、再入力が可能になります。
2. **メール送信失敗**: Webhook処理中にメール送信が失敗しても、決済データは保存されます。webhook_logsシートで確認してください。
3. **パスワード管理**: e-taxやe-Ltaxのパスワードは平文でGoogleシートに保存されます。アクセス権限を厳密に管理してください。

### トラブルシューティング
- **メールが届かない**: webhook_logsシートで`sendLP2Email`のログを確認
- **認証失敗**: masterシートのE列（メールアドレス）を確認
- **データが保存されない**: webhook_logsシートで`saveLP2Data`のログを確認
- **LP2にリダイレクトされない**: `createStripeCheckoutSession()`の`success_url`を確認

---

## 🎯 成功基準

以下がすべて✅になれば、LP2実装完了です：

- ✅ 決済完了後、LP2にリダイレクトされる
- ✅ LP2案内メールが自動送信される
- ✅ 認証モーダルが正しく動作する
- ✅ 個人/法人で適切なフォームが表示される
- ✅ 詳細情報がGoogle SheetsのAG-AW列に保存される
- ✅ 一度入力すると、再編集不可になる
- ✅ 再アクセス時に「入力済み」メッセージが表示される

---

**作成日**: 2025年10月27日  
**バージョン**: 1.0  
**最終更新**: 2025年10月27日



