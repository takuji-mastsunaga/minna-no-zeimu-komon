# ✅ 本番反映チェックリスト

テスト環境から本番環境への反映時に使用するチェックリストです。

---

## 📋 反映前チェック

### 1. テスト環境での検証

- [ ] **機能テスト完了**
  - [ ] LP1（申し込みフォーム）の動作確認
  - [ ] Stripe決済フローの確認
  - [ ] LP2（詳細入力ページ）の動作確認
  - [ ] データ保存の確認
  - [ ] メール送信の確認

- [ ] **複数シナリオでテスト**
  - [ ] 個人・青色申告
  - [ ] 個人・白色申告
  - [ ] 法人・青色申告
  - [ ] 法人・白色申告
  - [ ] インボイスあり/なし
  - [ ] 各種オプション選択

- [ ] **エラーハンドリング確認**
  - [ ] 不正な入力値の処理
  - [ ] ネットワークエラーの処理
  - [ ] 決済キャンセル時の処理
  - [ ] タイムアウト時の処理

- [ ] **Google Sheetsデータ確認**
  - [ ] pending_applicationsへの保存
  - [ ] masterへの移動
  - [ ] keysシートの更新
  - [ ] webhook_logsの記録

### 2. 変更内容の確認

- [ ] **変更ファイルリスト作成**
  - [ ] Code.gs（GAS）の変更内容
  - [ ] HTML（フロントエンド）の変更内容
  - [ ] 新規追加ファイル
  - [ ] 削除ファイル

- [ ] **変更履歴の記録**
  - [ ] TEST-CHANGELOG.mdに記録済み
  - [ ] 変更理由の明記
  - [ ] 影響範囲の特定

- [ ] **バックアップの作成**
  - [ ] 本番用Code.gsのバックアップ
  - [ ] 本番用HTMLのバックアップ
  - [ ] Google Sheetsのコピー作成

### 3. 本番環境の準備

- [ ] **環境変数の確認**
  - [ ] SPREADSHEET_IDが本番用になっているか
  - [ ] LP2_DETAIL_URLが本番用になっているか
  - [ ] STRIPE_MODEの設定（必要に応じてliveに変更）

- [ ] **タイミングの確認**
  - [ ] 営業時間外の実施（推奨）
  - [ ] ユーザーへの影響が最小限
  - [ ] ロールバック可能な時間帯

---

## 🚀 反映手順

### ステップ1: GASの更新

- [ ] 本番用Apps Scriptプロジェクトを開く
- [ ] Code.gsのバックアップを取る（コメントでバージョン番号を記録）
- [ ] テスト環境のCode-test.gsから変更部分をコピー
- [ ] ⚠️ テスト専用機能（`tak`認証など）は除外
- [ ] 保存（Ctrl+S / Cmd+S）
- [ ] 「デプロイ」→「新しいデプロイ」
- [ ] バージョン番号を入力（例: v34）
- [ ] デプロイ実行
- [ ] 新しいWeb App URLを取得
- [ ] 旧バージョンへのロールバック方法を確認

**新しいGAS URL**:
```
https://script.google.com/macros/s/【ここに記入】/exec
```

### ステップ2: HTMLファイルの更新

- [ ] 1218tst.htmlを開く
- [ ] GAS_API_URLを新しいURLに更新
- [ ] lp2-detail.htmlを開く
- [ ] GAS_API_URLを新しいURLに更新
- [ ] ローカルで動作確認（可能であれば）
- [ ] Gitコミット（変更履歴を残す）

### ステップ3: Vercelへのデプロイ

- [ ] ターミナルを開く
- [ ] 以下のコマンドを実行:
```bash
cd /Users/takujimatsunaga/minna-no-zeimu-komon
git add .
git commit -m "Update: [変更内容を記入]"
vercel --prod
```
- [ ] デプロイ完了を確認
- [ ] Production URLを確認

### ステップ4: Stripe Webhook URLの更新（GAS URLが変更された場合）

- [ ] Stripe Dashboardを開く
- [ ] 「開発者」→「Webhooks」
- [ ] 該当のWebhookエンドポイントを選択
- [ ] エンドポイントURLを新しいGAS URLに更新
- [ ] 「エンドポイントを更新」をクリック
- [ ] Webhookシークレットが変更されていないか確認

### ステップ5: 本番環境での動作確認

- [ ] **基本動作確認**
  - [ ] LP1にアクセス: `https://minna-no-zeimu-komon.vercel.app/1218tst.html`
  - [ ] フォームが正常に表示される
  - [ ] テストデータで申し込み（少額テスト）
  - [ ] Stripe決済ページにリダイレクトされる
  - [ ] テストカードで決済（または実際の少額決済）
  - [ ] LP2にリダイレクトされる
  - [ ] LP2で詳細情報を入力
  - [ ] 完了画面が表示される

- [ ] **データ確認**
  - [ ] Google Sheets本番シートを開く
  - [ ] pending_applicationsにデータが保存される
  - [ ] 決済完了後、masterに移動する
  - [ ] keysシートが正しく更新される
  - [ ] webhook_logsにログが記録される
  - [ ] LP2データがAG-AU列に保存される

- [ ] **メール確認**
  - [ ] LP2案内メールが送信される
  - [ ] 件名と本文が正しい
  - [ ] LP2リンクが有効

---

## 🔍 反映後の監視

### 最初の24時間

- [ ] **1時間後**: Google Sheetsのデータを確認
- [ ] **3時間後**: webhook_logsを確認
- [ ] **6時間後**: エラーログを確認
- [ ] **24時間後**: 総合的な動作確認

### 確認項目

- [ ] **エラーの発生**
  - [ ] webhook_logsにエラーがないか
  - [ ] GAS実行ログにエラーがないか
  - [ ] Stripe Dashboardにエラーがないか

- [ ] **データの整合性**
  - [ ] pending_applicationsとmasterのデータが正しいか
  - [ ] keysシートの対応関係が正しいか
  - [ ] 決済データが正しく記録されているか

- [ ] **顧客からの問い合わせ**
  - [ ] 決済エラーの報告
  - [ ] メール未受信の報告
  - [ ] フォーム動作の問題

---

## 🔙 ロールバック手順

問題が発生した場合の緊急対応:

### GASのロールバック

1. Apps Scriptプロジェクトを開く
2. 「デプロイ」→「デプロイを管理」
3. 前のバージョンを選択
4. 「アクティブ」に設定
5. 1218tst.html と lp2-detail.html のGAS_API_URLを旧URLに戻す
6. Vercelへ再デプロイ

### HTMLのロールバック

1. Gitで前のコミットに戻す:
```bash
git revert HEAD
git push
vercel --prod
```

### 確認

- [ ] ロールバック完了を確認
- [ ] 基本動作を確認
- [ ] 顧客への影響を最小限に

---

## 📝 反映完了後の作業

- [ ] **ドキュメントの更新**
  - [ ] PRODUCTION-SETUP.mdのバージョン番号更新
  - [ ] TEST-CHANGELOG.mdに「本番反映済み」を記録
  - [ ] デプロイIDとURLを記録

- [ ] **チーム共有**
  - [ ] 変更内容を関係者に共有
  - [ ] 新機能の使い方を共有（必要に応じて）
  - [ ] トラブル時の連絡先を確認

- [ ] **次回に向けて**
  - [ ] 改善点をメモ
  - [ ] トラブルがあればトラブルシューティングに追記
  - [ ] チェックリストの改善

---

## 📅 反映履歴

### 2025-10-29 - v33
- **反映内容**: 初期セットアップ
- **反映者**: （担当者名）
- **結果**: ✅ 成功 / ❌ 失敗 / ⚠️ 一部問題あり
- **備考**: 

---

**最終更新**: 2025-10-29  
**管理者**: （担当者名）

