# LP2（詳細情報入力ページ）設計書

## 📋 概要

決済完了後、税務顧問サービスに必要な詳細情報を収集するためのページ。
個人/法人を自動判定し、適切なフォームを表示する。

---

## 🔄 システムフロー

```
LP1（基本情報入力）
  ↓
pending_applications に一時保存
  ↓
Stripe決済
  ↓ 決済完了
Webhook受信 → master シートに移動（AC-AF列：決済情報保存済み）
  ↓
LP2のページをリロード（Stripe Checkoutの success_url でLP2にリダイレクト）
  ↓
メール送信（Stripe Webhookから、GmailApp使用）
  ↓
顧客がメール内のLP2リンクをクリック
  ↓
LP2アクセス（URL: lp2-detail.html?session_id=xxx）
  ↓
簡易認証：メールアドレスの最初の3文字入力（3回まで）
  ↓ 認証成功
LP2フォーム表示（個人/法人を自動判定）
  ↓
顧客が詳細情報を入力
  ↓
送信 → masterシートのAG列以降に保存
  ↓
入力済みフラグを設定（再編集不可）
```

---

## 🎨 LP2ページ構成

### ファイル名
`lp2-detail.html`

### URLパラメータ
- `session_id`: Stripe Checkout Session ID（必須）

### ページ構成
1. **認証エリア**（初回アクセス時のみ）
2. **ヘッダー**
3. **確認事項・注意書き**
4. **入力フォーム**（個人/法人で動的に切り替え）
5. **送信ボタン**
6. **入力済み表示**（既に入力済みの場合）

---

## 🔐 簡易認証機能

### 認証フロー
1. LP2アクセス時、認証モーダルを表示
2. 「申込時のメールアドレスの最初の3文字を入力してください」
3. GAS APIで検証：
   - session_id → UUID → masterシートのE列（メールアドレス）
   - 入力された3文字と照合
4. **成功**: フォーム表示
5. **失敗**: エラーメッセージ表示、再入力可能（最大3回）
6. **3回失敗**: 「minzei@solvis-group.comまでお問い合わせください」と表示、入力不可

### 認証エラーメッセージ
- 1回目: 「メールアドレスの最初の3文字が一致しません。もう一度お試しください。（残り2回）」
- 2回目: 「メールアドレスの最初の3文字が一致しません。もう一度お試しください。（残り1回）」
- 3回目: 「認証に失敗しました。お手数ですが、minzei@solvis-group.com までお問い合わせください。」

---

## 📝 入力項目定義

### 共通項目（個人・法人共通）
- **会計ソフト使用状況**: ラジオボタン（使用している / 使用していない）
- **使用している会計ソフト名**: セレクトボックス（「使用している」選択時のみ表示）
  - マネーフォワード
  - freee
  - その他
- **その他会計ソフト名**: テキスト入力（「その他」選択時のみ表示）
- **メールアドレス（クラウド会計用）**: テキスト入力

### 個人Ver 入力項目

| 項目名 | 入力タイプ | 必須 | バリデーション | スプレッドシート列 |
|--------|-----------|------|---------------|-------------------|
| 名前 | テキスト | ✅ | 1文字以上 | AJ |
| フリガナ | テキスト | ✅ | カタカナのみ | AK |
| 郵便番号 | テキスト（7桁） | ✅ | 数字7桁、ハイフンなし | AL |
| 住所 | テキスト | ✅ | 1文字以上 | AM |
| e-tax 利用者識別番号 | テキスト（16桁） | ✅ | 数字16桁 | AN |
| e-tax パスワード | パスワード | ✅ | 1文字以上 | AO |
| 会計ソフト使用状況 | ラジオボタン | ✅ | 使用している/していない | AR |
| 使用している会計ソフト名 | セレクト | 条件付き | 「使用している」選択時必須 | AS |
| その他会計ソフト名 | テキスト | 条件付き | 「その他」選択時必須 | AT |
| メールアドレス（クラウド会計用） | テキスト | ✅ | メール形式 | AU |

**空欄となる列**:
- AG: （空欄）
- AH: （空欄）
- AI: （空欄）
- AP: （空欄）
- AQ: （空欄）

### 法人Ver 入力項目

| 項目名 | 入力タイプ | 必須 | バリデーション | スプレッドシート列 |
|--------|-----------|------|---------------|-------------------|
| 法人名 | テキスト | ✅ | 1文字以上 | AG |
| 法人郵便番号 | テキスト（7桁） | ✅ | 数字7桁、ハイフンなし | AH |
| 法人住所 | テキスト | ✅ | 1文字以上 | AI |
| 代表者名 | テキスト | ✅ | 1文字以上 | AJ |
| 代表者フリガナ | テキスト | ✅ | カタカナのみ | AK |
| 代表者郵便番号 | テキスト（7桁） | ✅ | 数字7桁、ハイフンなし | AL |
| 代表者住所 | テキスト | ✅ | 1文字以上 | AM |
| e-tax 利用者識別番号 | テキスト（16桁） | ✅ | 数字16桁 | AN |
| e-tax 暗証番号 | パスワード | ✅ | 1文字以上 | AO |
| e-Ltax 利用者ID | テキスト | ✅ | 1文字以上 | AP |
| e-Ltax 暗証番号 | パスワード | ✅ | 1文字以上 | AQ |
| 会計ソフト使用状況 | ラジオボタン | ✅ | 使用している/していない | AR |
| 使用している会計ソフト名 | セレクト | 条件付き | 「使用している」選択時必須 | AS |
| その他会計ソフト名 | テキスト | 条件付き | 「その他」選択時必須 | AT |
| メールアドレス（クラウド会計用） | テキスト | ✅ | メール形式 | AU |

---

## 📊 スプレッドシート列定義（AG-AU列）

### masterシート 列構成

| 列 | 列名（ヘッダー） | 個人 | 法人 | データ型 |
|----|----------------|------|------|---------|
| AG | 法人名 | （空欄） | 法人名 | テキスト |
| AH | 法人郵便番号 | （空欄） | 法人郵便番号 | テキスト（7桁） |
| AI | 法人住所 | （空欄） | 法人住所 | テキスト |
| AJ | 代表者名/名前 | 名前 | 代表者名 | テキスト |
| AK | フリガナ | フリガナ | 代表者フリガナ | テキスト（カタカナ） |
| AL | 代表者郵便番号/郵便番号 | 郵便番号 | 代表者郵便番号 | テキスト（7桁） |
| AM | 代表者住所/住所 | 住所 | 代表者住所 | テキスト |
| AN | e-tax利用者識別番号 | e-tax番号 | e-tax番号 | テキスト（16桁） |
| AO | e-tax暗証番号/パスワード | e-tax PASS | e-tax暗証番号 | テキスト |
| AP | e-Ltax利用者ID | （空欄） | e-Ltax ID | テキスト |
| AQ | e-Ltax暗証番号 | （空欄） | e-Ltax暗証番号 | テキスト |
| AR | 会計ソフト使用状況 | 使用状況 | 使用状況 | テキスト |
| AS | 使用会計ソフト名 | ソフト名 | ソフト名 | テキスト |
| AT | その他会計ソフト名 | その他名 | その他名 | テキスト |
| AU | クラウド会計メールアドレス | メールアドレス | メールアドレス | テキスト |
| AV | LP2入力完了フラグ | TRUE/FALSE | TRUE/FALSE | ブール値 |
| AW | LP2入力日時 | タイムスタンプ | タイムスタンプ | 日時 |

---

## 🔧 GAS API設計

### API アクション一覧

#### 1. `authenticateLP2`
**目的**: LP2アクセス時の簡易認証

**リクエスト**:
```javascript
{
  action: 'authenticateLP2',
  sessionId: 'cs_test_xxx',
  emailPrefix: 'abc' // メールアドレスの最初の3文字
}
```

**処理フロー**:
1. session_id → UUID を取得（keysシート）
2. UUID → masterシートの行を検索
3. E列（メールアドレス）の最初の3文字と照合（大文字小文字区別なし）
4. 一致判定

**レスポンス成功**:
```javascript
{
  success: true,
  authenticated: true,
  entityType: 'individual' // or 'corporate'
}
```

**レスポンス失敗**:
```javascript
{
  success: true,
  authenticated: false,
  message: 'メールアドレスの最初の3文字が一致しません'
}
```

---

#### 2. `getLP2FormData`
**目的**: LP2フォーム表示用データ取得

**リクエスト**:
```javascript
{
  action: 'getLP2FormData',
  sessionId: 'cs_test_xxx'
}
```

**処理フロー**:
1. session_id → UUID を取得
2. UUID → masterシートの行を検索
3. AV列（LP2入力完了フラグ）をチェック
4. entityType（個人/法人）を取得
5. 既存のLP2データがあれば取得（AG-AU列）

**レスポンス（未入力）**:
```javascript
{
  success: true,
  completed: false,
  entityType: 'individual', // or 'corporate'
  data: null
}
```

**レスポンス（入力済み）**:
```javascript
{
  success: true,
  completed: true,
  completedAt: '2025-10-27T10:30:00.000Z',
  message: '詳細情報は既に入力済みです。変更がある場合は、minzei@solvis-group.comまでお問い合わせください。',
  data: {
    // AG-AU列のデータ（参照用、編集不可）
    corporationName: '株式会社テスト',
    // ...
  }
}
```

---

#### 3. `saveLP2Data`
**目的**: LP2で入力された詳細情報を保存

**リクエスト（個人）**:
```javascript
{
  action: 'saveLP2Data',
  sessionId: 'cs_test_xxx',
  data: {
    name: '山田太郎',
    nameKana: 'ヤマダタロウ',
    postalCode: '1234567',
    address: '東京都千代田区...',
    etaxNumber: '1234567890123456',
    etaxPassword: 'password123',
    accountingSoftwareUsage: '使用している',
    accountingSoftwareName: 'マネーフォワード',
    accountingSoftwareOther: '',
    cloudAccountingEmail: 'test@example.com'
  }
}
```

**リクエスト（法人）**:
```javascript
{
  action: 'saveLP2Data',
  sessionId: 'cs_test_xxx',
  data: {
    corporationName: '株式会社テスト',
    corporationPostalCode: '1234567',
    corporationAddress: '東京都千代田区...',
    representativeName: '山田太郎',
    representativeNameKana: 'ヤマダタロウ',
    representativePostalCode: '7654321',
    representativeAddress: '東京都港区...',
    etaxNumber: '1234567890123456',
    etaxPassword: 'password123',
    eltaxId: 'eltax123',
    eltaxPassword: 'eltaxpass',
    accountingSoftwareUsage: '使用している',
    accountingSoftwareName: 'freee',
    accountingSoftwareOther: '',
    cloudAccountingEmail: 'test@example.com'
  }
}
```

**処理フロー**:
1. session_id → UUID を取得
2. UUID → masterシートの行を検索
3. AV列（LP2入力完了フラグ）をチェック
   - 既にTRUEの場合 → エラー返却
4. entityType（個人/法人）を取得
5. AG-AU列に適切にデータを保存
   - 個人の場合: AG, AH, AI, AP, AQ は空欄
   - 法人の場合: すべて入力
6. AV列にTRUEを設定
7. AW列に現在日時を記録

**レスポンス成功**:
```javascript
{
  success: true,
  message: '詳細情報を保存しました'
}
```

**レスポンス失敗（既に入力済み）**:
```javascript
{
  success: false,
  error: 'already_completed',
  message: '詳細情報は既に入力済みです。変更がある場合は、minzei@solvis-group.comまでお問い合わせください。'
}
```

---

## 📧 メール送信機能

### 送信タイミング
Stripe Webhook（`checkout.session.completed`）処理後、`moveFromPendingToMaster`完了時

### 送信方法
GAS `GmailApp.sendEmail()` または `MailApp.sendEmail()`

### メールテンプレート

#### 件名
```
【みんなの税務顧問】お申し込みありがとうございます - 詳細情報のご入力をお願いいたします
```

#### 本文（個人・法人共通）
```
{お名前} 様

この度は「みんなの税務顧問」にお申し込みいただき、誠にありがとうございます。

決済が正常に完了いたしました。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■ 次のステップ：詳細情報のご入力
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

税務顧問サービスの開始にあたり、必要な詳細情報のご入力をお願いいたします。

以下のリンクから、詳細情報の入力ページにアクセスしてください：

▼ 詳細情報入力ページ
{LP2のURL（session_id付き）}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■ ご注意
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

・このリンクはお客様専用です。他の方と共有しないでください。
・詳細情報は一度入力されると、変更ができません。
・入力内容に変更が必要な場合は、minzei@solvis-group.com までご連絡ください。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■ 今後の流れ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. 詳細情報のご入力（本メールのリンクから）
2. 担当者より3営業日以内にご連絡
3. 必要書類のご案内
4. オンライン面談の日程調整
5. サービス開始

━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ご不明な点がございましたら、お気軽にお問い合わせください。

みんなの税務顧問 運営事務局
メール：minzei@solvis-group.com

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### メール変数
- `{お名前}`: masterシートのC列（姓）+ D列（名）
- `{LP2のURL}`: `https://your-vercel-domain/lp2-detail.html?session_id={session_id}`

---

## 🎨 UI/UX仕様

### デザイン要件
1. **レスポンシブデザイン**: スマホ・タブレット・PC対応
2. **LP1との統一感**: 既存のLP1のデザインを踏襲
3. **入力しやすさ**: 
   - 大きめの入力フィールド
   - 郵便番号からの住所自動入力
   - バリデーションメッセージを各フィールドの下に表示

### 認証モーダル
- 中央に表示、背景はオーバーレイ
- 「メールアドレスの最初の3文字を入力してください」
- 入力フィールド（3文字、大文字小文字区別なし）
- 「確認」ボタン
- 試行回数表示（残り2回、残り1回）

### 確認事項表示
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 確認事項
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

この内容は税務顧問サービスに必要な情報ですので、
必ずご記入をお願いいたします。

⚠️ 一度送信された情報は変更できません。
正確にご入力ください。

変更が必要な場合は、minzei@solvis-group.com まで
お問い合わせください。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 入力済み表示
LP2入力完了フラグがTRUEの場合：
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 詳細情報は既に入力済みです
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

入力日時: 2025年10月27日 10:30

詳細情報の入力は完了しております。
担当者より3営業日以内にご連絡いたします。

入力内容に変更が必要な場合は、
minzei@solvis-group.com までお問い合わせください。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### バリデーション
- **リアルタイムバリデーション**: フォーカスアウト時にチェック
- **送信時バリデーション**: 全項目を再チェック
- **エラー表示**: 各フィールドの下に赤字で表示

### バリデーションメッセージ例
- 名前: 「お名前を入力してください」
- フリガナ: 「フリガナはカタカナで入力してください」
- 郵便番号: 「郵便番号は7桁の数字で入力してください（ハイフンなし）」
- e-tax番号: 「e-tax利用者識別番号は16桁の数字で入力してください」
- メールアドレス: 「正しいメールアドレス形式で入力してください」

---

## 🔒 セキュリティ仕様

### 認証
1. **簡易認証**: メールアドレスの最初の3文字（3回まで）
2. **セッション管理**: URLパラメータ（session_id）を使用、サーバー側でUUIDと紐づけ

### データ保護
1. **パスワードフィールド**: `type="password"`で入力を隠す（ただしGoogleシートには平文保存）
2. **HTTPS**: Vercelで自動的にHTTPS化
3. **再編集防止**: AV列（LP2入力完了フラグ）でチェック、一度TRUEになったら編集不可

### エラーハンドリング
- 不正なsession_id: 「無効なリンクです。メールをご確認ください。」
- 認証失敗（3回）: 「認証に失敗しました。minzei@solvis-group.com までお問い合わせください。」
- 既に入力済み: 「詳細情報は既に入力済みです。変更が必要な場合は、minzei@solvis-group.com までお問い合わせください。」

---

## 📱 レスポンシブ対応

### ブレークポイント
- スマホ: ~767px
- タブレット: 768px~1023px
- PC: 1024px~

### スマホ対応
- 入力フィールドを縦に配置
- フォントサイズを大きめに（最小16px、iOSのズーム防止）
- タップしやすいボタンサイズ（最小44px × 44px）

---

## ✅ テストシナリオ

### 1. 正常系
1. ✅ 決済完了後、LP2にリダイレクトされる
2. ✅ メールが送信される
3. ✅ メール内のリンクからLP2にアクセスできる
4. ✅ 認証モーダルで正しい3文字を入力すると、フォームが表示される
5. ✅ 個人の場合、個人用フォームが表示される
6. ✅ 法人の場合、法人用フォームが表示される
7. ✅ すべての必須項目を入力して送信すると、成功メッセージが表示される
8. ✅ Google Sheetsの該当行のAG-AW列にデータが保存される
9. ✅ 再度アクセスすると、「入力済み」メッセージが表示される

### 2. 異常系
1. ❌ 認証で間違った3文字を入力すると、エラーメッセージが表示される
2. ❌ 認証で3回失敗すると、入力不可になる
3. ❌ 必須項目が未入力の場合、バリデーションエラーが表示される
4. ❌ 既に入力済みのデータを再送信しようとすると、エラーが返る
5. ❌ 無効なsession_idでアクセスすると、エラーメッセージが表示される

---

## 📦 成果物リスト

実装時に作成するファイル：

1. **lp2-detail.html**: LP2ページ本体
2. **Code.gs（追加機能）**:
   - `authenticateLP2()`: 認証機能
   - `getLP2FormData()`: フォームデータ取得
   - `saveLP2Data()`: LP2データ保存
   - `sendLP2Email()`: LP2案内メール送信
   - `handleCheckoutCompleted()`の修正: メール送信追加
3. **スプレッドシート**:
   - masterシートにAG-AW列のヘッダー追加
   - （オプション）LP2入力状況確認用のビュー作成

---

## 🚀 実装優先順位

### フェーズ1: コア機能（最優先）
1. LP2認証API（`authenticateLP2`）
2. LP2データ取得API（`getLP2FormData`）
3. LP2データ保存API（`saveLP2Data`）
4. LP2 HTML基本構造
5. 個人/法人フォーム切り替え

### フェーズ2: メール送信
1. メール送信機能（`sendLP2Email`）
2. Webhook処理にメール送信追加

### フェーズ3: UX向上
1. 郵便番号→住所自動入力
2. リアルタイムバリデーション
3. ローディング表示
4. 送信完了アニメーション

### フェーズ4: セキュリティ強化（オプション）
1. 有効期限設定（7日間など）
2. アクセスログ記録

---

## 📝 備考

- **パスワードの扱い**: e-taxやe-Ltaxのパスワードは平文でGoogleシートに保存されます。より高いセキュリティが必要な場合は、暗号化を検討してください。
- **再編集の要望**: 顧客から再編集の要望があった場合、管理者が手動でAV列をFALSEに変更することで、再入力が可能になります。
- **メール送信失敗**: Webhook処理中にメール送信が失敗しても、決済データは保存されます。メール送信ログを別途記録することを推奨します。

---

**作成日**: 2025年10月27日  
**バージョン**: 1.0  
**最終更新**: 2025年10月27日



