<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>契約までの確認事項</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Sans","Noto Sans JP",sans-serif;background:#F0F4F8;min-height:100vh}
    .container{max-width:800px;width:100%;margin:0 auto;background:#fff;min-height:100vh;box-shadow:0 0 20px rgba(0,0,0,.05)}
    .header{background:#fff;padding:20px 15px;text-align:center;border-bottom:1px solid #E5E7EB;position:sticky;top:0;z-index:100}
    .header h1{font-size:18px;color:#1F2937;font-weight:600}
    .content{padding:40px;min-height:500px;max-width:720px;margin:0 auto}
    @media (min-width:1024px){.content{padding:60px 40px}.industry-grid{grid-template-columns:repeat(2,1fr);max-width:600px;margin:20px auto}.price-plans{max-width:600px;margin:30px auto}.final-options{max-width:600px;margin:30px auto}.price-summary{max-width:600px;margin:30px auto}.option-card{max-width:600px;margin-left:auto;margin-right:auto}.input-group{max-width:500px;margin-left:auto;margin-right:auto;margin-bottom:20px}}
    .step{display:none;animation:fadeIn .4s ease}.step.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .question{font-size:22px;color:#1F2937;margin-bottom:8px;font-weight:600;text-align:center}
    .sub-text{text-align:center;color:#6B7280;font-size:14px;margin-bottom:30px}
    .sub-text::before{content:"※";margin-right:4px}
    .option-card{background:#fff;border:2px solid #E0F2F1;border-radius:12px;padding:20px;margin-bottom:15px;cursor:pointer;transition:.3s ease;position:relative;display:flex;align-items:center;justify-content:space-between}
    .option-card:hover{border-color:#26A69A;background:#F0FDF9}
    .option-card.selected{background:#E6FFFA;border-color:#26A69A}
    .option-card.disabled{opacity:.6;cursor:not-allowed}
    .option-card.info-only{cursor:default;background:#fff;border-color:#E5E7EB}
    .option-card.info-only .option-text{font-size:14px;color:#6B7280}
    .option-card.info-only .option-text strong{font-size:14px;color:#374151}
    .option-card.info-only .option-text small{font-size:12px;color:#6B7280}
    .option-text{flex:1;font-size:16px;color:#374151;display:flex;align-items:center;gap:10px}
    .info-btn{width:32px;height:32px;border-radius:50%;border:2px solid #E0F2F1;background:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.3s ease;color:#9CA3AF;font-size:16px;font-weight:700;flex-shrink:0}
    .info-btn:hover{background:#26A69A;color:#fff;border-color:#26A69A}
    .info-tooltip{display:none;position:absolute;right:50px;top:50%;transform:translateY(-50%);background:#fff;border:2px solid #E0F2F1;border-radius:12px;padding:15px;width:300px;box-shadow:0 10px 25px rgba(0,0,0,.1);z-index:1000}
    .info-tooltip.show{display:block;animation:tooltipFadeIn .3s ease}
    .info-tooltip h4{color:#26A69A;margin-bottom:8px;font-size:14px}
    .info-tooltip p{color:#6B7280;font-size:13px;line-height:1.6}
    .checkbox-wrapper{display:flex;align-items:center;width:100%}
    .checkbox-wrapper input[type="checkbox"]{width:20px;height:20px;margin-right:12px;cursor:pointer;accent-color:#26A69A}
    .checkbox-wrapper label{cursor:pointer;color:#374151;font-size:15px;user-select:none;flex:1}
    .input-group{margin-bottom:20px}
    .input-group label{display:block;margin-bottom:8px;font-weight:600;color:#374151;font-size:14px}
    .input-group input{width:100%;padding:12px 16px;border:2px solid #E0F2F1;border-radius:8px;font-size:16px;transition:.3s ease;background:#fff}
    .invoice-input-group{margin-bottom:20px;max-width:500px;margin-left:auto;margin-right:auto}
    .invoice-input-wrapper{display:flex;align-items:center;border:2px solid #E0F2F1;border-radius:8px;overflow:hidden;transition:.3s ease}
    .invoice-input-wrapper:focus-within{border-color:#26A69A;box-shadow:0 0 0 3px rgba(38,166,154,.1)}
    .invoice-prefix{background:#F3F4F6;padding:12px 16px;font-size:16px;font-weight:600;color:#374151;border-right:1px solid #E5E7EB}
    .invoice-input-wrapper input{flex:1;padding:12px 16px;border:none;font-size:16px;background:#fff;outline:none}
    .btn-group{display:flex;flex-direction:column;gap:15px;margin-top:40px;align-items:center}
    .btn-group-top{display:flex;gap:15px;justify-content:center;flex-wrap:wrap}
    .btn{padding:14px 32px;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:.3s ease;min-width:140px}
    .btn-primary{background:#26A69A;color:#fff}.btn-primary:hover{background:#00897B;transform:translateY(-2px);box-shadow:0 8px 20px rgba(38,166,154,.3)}
    .btn-secondary{background:#6B7280;color:#fff}.btn-secondary:hover{background:#4B5563}
    .btn-back{background:#fff;color:#6B7280;border:2px solid #E5E7EB}.btn-back:hover{background:#F9FAFB}
    .warning-box{background:#FEF3C7;border-left:4px solid #F59E0B;padding:15px;border-radius:8px;margin:20px 0}
    .error-box{background:#FEE2E2;border-left:4px solid #EF4444;padding:20px;border-radius:8px;text-align:center}
    .success-box{background:#D1FAE5;border-left:4px solid #10B981;padding:15px;border-radius:8px;margin:20px 0}
    .industry-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:15px;margin:20px 0}
    .industry-item{background:#fff;border:2px solid #E0F2F1;border-radius:12px;padding:15px;cursor:pointer;transition:.3s ease}
    .industry-item:hover{border-color:#26A69A;background:#F0FDF9}
    .industry-item.selected{background:#E6FFFA;border-color:#26A69A}
    .industry-item strong{display:block;color:#1F2937;margin-bottom:4px}
    .industry-item small{color:#6B7280;font-size:12px}
    .price-summary{background:linear-gradient(135deg,#F0FDF9 0%,#E6FFFA 100%);border-radius:12px;padding:25px;margin:30px 0}
    .price-summary h2{color:#1F2937;margin-bottom:20px;font-size:20px}
    .price-item{display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid rgba(0,0,0,.08)}
    .price-item:last-child{border-bottom:none;padding-top:20px;margin-top:10px;border-top:2px solid rgba(38,166,154,.3);font-weight:700;font-size:18px}
    .price-plans{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin:30px 0}
    .plan-card{background:#fff;border:2px solid #E0F2F1;border-radius:12px;padding:25px;text-align:center;cursor:pointer;transition:.3s ease}
    .plan-card:hover{border-color:#26A69A;transform:translateY(-5px);box-shadow:0 10px 30px rgba(0,0,0,.1)}
    .plan-card.selected{border-color:#26A69A;background:#E6FFFA}
    .plan-card h3{color:#1F2937;margin-bottom:15px}
    .plan-price{font-size:28px;color:#26A69A;font-weight:700;margin-bottom:10px}
    .plan-price small{font-size:14px;color:#6B7280}
    .plan-total{color:#6B7280;font-size:14px;margin-top:10px}
    .final-options{margin:30px 0}
    .final-options h3{color:#1F2937;margin-bottom:20px}
    .option-with-input{display:flex;align-items:center;gap:15px;margin-left:35px;margin-top:10px}
    .option-with-input input[type="number"]{width:100px;padding:8px;border:2px solid #E0F2F1;border-radius:6px}
    @media (max-width:640px){.content{padding:25px}.industry-grid{grid-template-columns:1fr}.info-tooltip{width:250px;right:40px}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>契約までの確認事項</h1>
      <p>申告に必要な情報を入力をお願いいたします。</p>
    </div>

    <div class="content">
      <!-- Step 0: 利用規約 -->
      <div class="step active" id="step0">
        <div class="question">利用規約</div>
        <div class="option-card info-only">
          <div class="option-text">
            <div>
              <strong>本システムのご利用について</strong><br>
              <small style="color:#6B7280;line-height:1.6;">
                青色申告・白色申告の判定を行い、適切な税務申告をサポートします。<br>
                入力された情報は決済完了まで保存されませんので、ご安心ください。
              </small>
            </div>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="acceptTerms()">同意して進む</button>
        </div>
      </div>

      <!-- Step 1: 個人/法人選択 -->
      <div class="step" id="step1">
        <div class="question">個人ですか？法人ですか？</div>

        <div class="option-card" onclick="selectEntity('individual')">
          <div class="option-text">個人</div>
          <div class="info-btn" onclick="event.stopPropagation(); showInfo(this)">?</div>
          <div class="info-tooltip"><h4>個人とは</h4><p>副業や、フリーランス、個人事業主の略です。</p></div>
        </div>

        <div class="option-card" onclick="selectEntity('corporate')">
          <div class="option-text">法人</div>
          <div class="info-btn" onclick="event.stopPropagation(); showInfo(this)">?</div>
          <div class="info-tooltip"><h4>法人とは</h4><p>株式会社、合同会社等の法人格を持つ事業体です。</p></div>
        </div>

        <div class="btn-group">
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
        </div>
      </div>

      <!-- Step 2: 青色取消確認 -->
      <div class="step" id="step2">
        <div class="question">過去に青色申告の取り消しはありましたか？</div>
        <div class="option-card info-only">
          <div class="option-text"><strong>青色申告の取り消しについて</strong></div>
          <div class="info-btn" onclick="showInfo(this)">?</div>
          <div class="info-tooltip"><h4>青色申告の取り消しとは</h4><p>税務署から青色申告の承認を取り消されたことがある場合を指します。</p></div>
        </div>
        <div class="btn-group">
          <div class="btn-group-top">
            <button class="btn btn-secondary" onclick="handleCancellation(true)">はい</button>
            <button class="btn btn-primary" onclick="handleCancellation(false)">いいえ</button>
          </div>
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
        </div>
      </div>

      <!-- Step 3: 法人-青色申告有無確認 -->
      <div class="step" id="step3-corporate-check">
        <div class="question">青色申告はしていますか？</div>
        <div class="option-card info-only">
          <div class="option-text"><strong>青色申告について</strong></div>
          <div class="info-btn" onclick="showInfo(this)">?</div>
          <div class="info-tooltip"><h4>青色申告って何？</h4><p>複式簿記による記帳を行い、税務署の承認を受ける方法です。</p></div>
        </div>
        <div class="btn-group">
          <div class="btn-group-top">
            <button class="btn btn-primary" onclick="handleCorporateBlueStatus(true)">はい</button>
            <button class="btn btn-secondary" onclick="handleCorporateBlueStatus(false)">いいえ</button>
          </div>
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
        </div>
      </div>

      <!-- Step 3: 個人-青色申告有無 -->
      <div class="step" id="step3-individual">
        <div class="question">青色申告はしていますか？</div>
        <div class="option-card info-only">
          <div class="option-text"><strong>青色申告について</strong></div>
          <div class="info-btn" onclick="showInfo(this)">?</div>
          <div class="info-tooltip"><h4>青色申告って何？</h4><p>複式簿記による記帳を行い、税務署の承認を受ける方法です。</p></div>
        </div>
        <div class="btn-group">
          <div class="btn-group-top">
            <button class="btn btn-primary" onclick="handleBlueStatus(true)">はい</button>
            <button class="btn btn-secondary" onclick="handleBlueStatus(false)">いいえ</button>
          </div>
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
        </div>
      </div>

      <!-- Step 4: 個人-本年度前提出 -->
      <div class="step" id="step4-individual">
        <div class="question">本年度分が始まる前に提出しましたか？</div>
        <p class="sub-text">例）2025年度の申請の場合3/15より前に提出しましたか？</p>
        <div class="btn-group">
          <div class="btn-group-top">
            <button class="btn btn-primary" onclick="handleBeforeYear(true)">はい</button>
            <button class="btn btn-secondary" onclick="handleBeforeYear(false)">いいえ</button>
          </div>
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
        </div>
      </div>

      <!-- Step 5: 個人-開業届 -->
      <div class="step" id="step5-individual">
        <div class="question">開業届は出しましたか？</div>
        <div class="option-card info-only">
          <div class="option-text"><strong>開業届について</strong></div>
          <div class="info-btn" onclick="showInfo(this)">?</div>
          <div class="info-tooltip"><h4>開業届とは？</h4><p>個人事業の開業・廃業等届出書のことです。</p></div>
        </div>
        <div class="btn-group">
          <div class="btn-group-top">
            <button class="btn btn-primary" onclick="handleOpeningNotice(true)">はい</button>
            <button class="btn btn-secondary" onclick="handleOpeningNotice(false)">いいえ</button>
          </div>
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
        </div>
      </div>

      <!-- Step 6: 個人-2ヶ月以内提出 -->
      <div class="step" id="step6-individual">
        <div class="question">開業もしくは事業開始より2ヶ月以内に青色申告の届けを提出していますか？</div>
        <p class="sub-text">事業開始、または開業から2ヶ月以内</p>
        <div class="btn-group">
          <div class="btn-group-top">
            <button class="btn btn-primary" onclick="handleTwoMonths(true)">はい</button>
            <button class="btn btn-secondary" onclick="handleTwoMonths(false)">いいえ</button>
          </div>
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
        </div>
      </div>

      <!-- Step 7: 白色申告確認 -->
      <div class="step" id="step7-white">
        <div class="question">確認事項</div>
        <div class="warning-box">青色申告ができず白色申告となる可能性がありますが、申告しますか？</div>
        <div class="option-card">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="confirmWhite">
            <label for="confirmWhite">白色申告での申告を了承します</label>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
          <button class="btn btn-primary" onclick="confirmWhiteReturn()">続行する</button>
        </div>
      </div>

      <!-- Step 3: 法人-日付入力 -->
      <div class="step" id="step3-corporate">
        <div class="question">青色申告について情報の入力をしてください</div>
        <p class="sub-text">記載された内容は、決済まで保存されませんのでご安心ください</p>

        <div class="option-card info-only">
          <div class="option-text"><strong>各日付について</strong></div>
          <div class="info-btn" onclick="showInfo(this)">?</div>
          <div class="info-tooltip">
            <h4>日付の説明</h4>
            <p><strong>設立日：</strong>法人の設立登記が完了した日<br>
            <strong>青色申告提出日：</strong>青色申告承認申請書を税務署に提出した日<br>
            <strong>次回決算日：</strong>今期の事業年度の最終日</p>
          </div>
        </div>

        <div class="input-group">
          <label for="establishDate">設立日</label>
          <input type="date" id="establishDate" required>
        </div>
        <div class="input-group">
          <label for="submitDate">青色申告提出日</label>
          <input type="date" id="submitDate" required>
        </div>
        <div class="input-group">
          <label for="closingDate">次回決算日</label>
          <input type="date" id="closingDate" required>
        </div>

        <div class="btn-group">
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
          <button class="btn btn-primary" onclick="checkCorporateDates()">判定する</button>
        </div>
      </div>

      <!-- Step 8: インボイス -->
      <div class="step" id="step8-invoice">
        <div class="question">インボイス（適格）登録してますか？</div>
        <div class="option-card info-only">
          <div class="option-text"><strong>適格請求書発行事業者について</strong></div>
          <div class="info-btn" onclick="showInfo(this)">?</div>
          <div class="info-tooltip"><h4>適格請求書発行事業者</h4><p>Tから始まる13桁の数字です。</p></div>
        </div>
        <div class="btn-group">
          <div class="btn-group-top">
            <button class="btn btn-primary" onclick="handleInvoice(true)">はい</button>
            <button class="btn btn-secondary" onclick="handleInvoice(false)">いいえ</button>
          </div>
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
        </div>
      </div>

      <!-- Step 9: インボイス番号 -->
      <div class="step" id="step9-invoice-number">
        <div class="question">インボイス番号の記載をしてください</div>
        <p class="sub-text">Tから始まる13桁の数字を入力してください</p>

        <div class="option-card info-only" style="background:#FEF3C7;border-color:#F59E0B;">
          <div class="option-text">
            <strong>法人のお客様へ</strong><br>
            <small style="color:#92400E;">法人番号の先頭にTを付けたものがインボイス番号です。</small>
          </div>
        </div>

        <div class="option-card info-only">
          <div class="option-text"><strong>インボイス番号の確認方法</strong></div>
          <div class="info-btn" onclick="showInfo(this)">?</div>
          <div class="info-tooltip"><h4>インボイス番号の確認</h4><p>通知書で確認できます。</p></div>
        </div>

        <div class="invoice-input-group">
          <label for="invoiceNumber">インボイス番号（13桁の数字）</label>
          <div class="invoice-input-wrapper">
            <span class="invoice-prefix">T</span>
            <input type="text" id="invoiceNumber" placeholder="1234567890123" pattern="[0-9]{13}" maxlength="13" onkeypress="return event.charCode >= 48 && event.charCode <= 57">
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
          <button class="btn btn-primary" onclick="submitInvoiceNumber()">入力完了</button>
        </div>
      </div>

      <!-- Step 10: 消費税条件 -->
      <div class="step" id="step10-tax-conditions">
        <div class="question">該当する項目をすべて選択してください</div>
        <p class="sub-text">消費税申告が必要かどうかを判定します</p>

        <div class="option-card">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="tax1">
            <label for="tax1">過去一度も1000万円を超えた売上がない</label>
          </div>
          <div class="info-btn" onclick="showInfo(this)">?</div>
          <div class="info-tooltip"><h4>売上高について</h4><p>基準期間（2年前）の課税売上高が1000万円以下の場合</p></div>
        </div>

        <div class="option-card">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="tax2">
            <label for="tax2">前年度の1月から6月（1/1〜6/30）までに1000万円超の売上がない</label>
          </div>
          <div class="info-btn" onclick="showInfo(this)">?</div>
          <div class="info-tooltip"><h4>特定期間について</h4><p>特定期間の課税売上高による納税義務の判定</p></div>
        </div>

        <div class="option-card">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="tax3">
            <label for="tax3">消費税課税事業者選択届出書を提出していない</label>
          </div>
          <div class="info-btn" onclick="showInfo(this)">?</div>
          <div class="info-tooltip"><h4>課税事業者選択</h4><p>免税事業者が課税事業者となる届出</p></div>
        </div>

        <div class="option-card">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="tax4">
            <label for="tax4">今行っている事業は相続による事業ではない</label>
          </div>
          <div class="info-btn" onclick="showInfo(this)">?</div>
          <div class="info-tooltip"><h4>相続による事業承継</h4><p>被相続人の事業を引き継いだ場合の特例</p></div>
        </div>

        <div class="btn-group">
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
          <button class="btn btn-primary" onclick="checkTaxConditions()">確認</button>
        </div>
      </div>

      <!-- Step 11: 業種選択 -->
      <div class="step" id="step11-industry">
        <div class="question">業種を選択してください</div>
        <p class="sub-text">上記の業種はカッコ内の条件を満たす場合のみ対象となります</p>
        <div class="industry-grid">
          <div class="industry-item" onclick="toggleIndustry(this,'IT')"><strong>IT</strong></div>
          <div class="industry-item" onclick="toggleIndustry(this,'サービス業')"><strong>サービス業</strong></div>
          <div class="industry-item" onclick="toggleIndustry(this,'卸売業')"><strong>卸売業</strong></div>
          <div class="industry-item" onclick="toggleIndustry(this,'小売業')"><strong>小売業</strong></div>
          <div class="industry-item" onclick="toggleIndustry(this,'介護・福祉業')"><strong>介護・福祉業</strong></div>
          <div class="industry-item" onclick="toggleIndustry(this,'農業')"><strong>農業</strong></div>
          <div class="industry-item" onclick="toggleIndustry(this,'電気・ガス業')"><strong>電気・ガス業</strong><small>（下請け）</small></div>
          <div class="industry-item" onclick="toggleIndustry(this,'製造業')"><strong>製造業</strong><small>（原価計算が不要）</small></div>
          <div class="industry-item" onclick="toggleIndustry(this,'不動産業')"><strong>不動産業</strong><small>（仲介業のみ）</small></div>
          <div class="industry-item" onclick="toggleIndustry(this,'飲食業')"><strong>飲食業</strong><small>（連携可能なPOS）</small></div>
          <div class="industry-item" onclick="toggleIndustry(this,'建設業')"><strong>建設業</strong><small>（下請け・一人親方のみ）</small></div>
          <div class="industry-item" onclick="toggleIndustry(this,'運輸業')"><strong>運輸業</strong><small>（下請けのみ）</small></div>
        </div>
        <div class="btn-group">
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
          <button class="btn btn-primary" onclick="confirmIndustry()">次へ</button>
        </div>
      </div>

      <!-- Step 12: 専従者給与（個人） -->
      <div class="step" id="step12-dependent">
        <div class="question">専従者給与の支払いがありますか？</div>
        <div class="option-card info-only">
          <div class="option-text"><strong>専従者給与について</strong></div>
          <div class="info-btn" onclick="showInfo(this)">?</div>
          <div class="info-tooltip"><h4>専従者給与とは？</h4><p>生計を一にする配偶者その他の親族に支払う給与</p></div>
        </div>
        <div class="btn-group">
          <div class="btn-group-top">
            <button class="btn btn-primary" onclick="handleDependent(true)">はい</button>
            <button class="btn btn-secondary" onclick="handleDependent(false)">いいえ</button>
          </div>
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
        </div>
      </div>

      <!-- Step 13: 専従者届出（個人・青色） -->
      <div class="step" id="step13-dependent-blue">
        <div class="question">専従者の届出書がありますか？</div>
        <div class="btn-group">
          <div class="btn-group-top">
            <button class="btn btn-primary" onclick="handleDependentNotice(true)">はい</button>
            <button class="btn btn-secondary" onclick="handleDependentNotice(false)">いいえ</button>
          </div>
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
        </div>
      </div>

      <!-- Step 13-B: 白色専従者給与確認 -->
      <div class="step" id="step13-dependent-white-confirm">
        <div class="question">白色の専従者給与になります</div>
        <div class="warning-box">
          白色申告の専従者控除として処理されます。青色と異なり控除額に上限があります。
        </div>
        <div class="option-card">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="confirmWhiteDependent">
            <label for="confirmWhiteDependent">白色の専従者給与での申告を了承します</label>
          </div>
        </div>
        <div class="btn-group">
          <div class="btn-group-top">
            <button class="btn btn-primary" onclick="confirmWhiteDependent()">はい、続行する</button>
            <button class="btn btn-secondary" onclick="rejectWhiteDependent()">いいえ</button>
          </div>
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
        </div>
      </div>

      <!-- Step 14: 専従者条件（個人） -->
      <div class="step" id="step14-dependent-conditions">
        <div class="question">該当する項目をすべて選択してください</div>
        <p class="sub-text">青色事業専従者給与として認められるための条件です</p>

        <div class="option-card"><div class="checkbox-wrapper">
          <input type="checkbox" id="dep1"><label for="dep1">生計同一の配偶者・親族で15歳以上</label></div></div>
        <div class="option-card"><div class="checkbox-wrapper">
          <input type="checkbox" id="dep2"><label for="dep2">従事期間6ヶ月以上（1年目は期中の半分以上）</label></div></div>
        <div class="option-card"><div class="checkbox-wrapper">
          <input type="checkbox" id="dep3"><label for="dep3">届出した金額の範囲内</label></div></div>
        <div class="option-card"><div class="checkbox-wrapper">
          <input type="checkbox" id="dep4"><label for="dep4">実際に支払いをしている</label></div></div>
        <div class="option-card"><div class="checkbox-wrapper">
          <input type="checkbox" id="dep5"><label for="dep5">労務内容に対して妥当な金額</label></div></div>

        <div class="btn-group">
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
          <button class="btn btn-primary" onclick="checkDependentConditions()">確認</button>
        </div>
      </div>

      <!-- Step 12: 役員報酬（法人） -->
      <div class="step" id="step12-director">
        <div class="question">役員報酬はありますか？</div>
        <div class="btn-group">
          <div class="btn-group-top">
            <button class="btn btn-primary" onclick="handleDirector(true)">はい</button>
            <button class="btn btn-secondary" onclick="handleDirector(false)">いいえ</button>
          </div>
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
        </div>
      </div>

      <!-- Step 13: 役員報酬条件（法人） -->
      <div class="step" id="step13-director-conditions">
        <div class="question">役員報告に関わるチェック項目</div>

        <div class="option-card"><div class="checkbox-wrapper">
          <input type="checkbox" id="dir1"><label for="dir1">社会保険に加入している方</label></div></div>
        <div class="option-card"><div class="checkbox-wrapper">
          <input type="checkbox" id="dir2"><label for="dir2">毎月定額での役員報酬を定めている方(例：10万円/月)</label></div></div>
        <div class="option-card"><div class="checkbox-wrapper">
          <input type="checkbox" id="dir3"><label for="dir3">金額の決定は設立/事業開始年度から3ヶ月以内</label></div></div>

        <div class="btn-group">
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
          <button class="btn btn-primary" onclick="checkDirectorConditions()">確認</button>
        </div>
      </div>

      <!-- Step 14: 源泉徴収特例（法人/従業員ルートのみ） -->
      <div class="step" id="step14-withholding">
        <div class="question">源泉徴収票の特例を出して良いですか？</div>

        <div class="warning-box">
          <strong>注意</strong><br>
          ・法定調書、年末調整は必要なので<strong>オプション</strong>です。<br>
          ・上記は<strong>12月までの申し込みに限り当年分の対応</strong>となります。<br>
          ・最終オプションで、選択ください。
        </div>

        <div class="option-card">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="withholding1">
            <label for="withholding1">源泉徴収票の特例を申請する</label>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
          <button class="btn btn-primary" onclick="confirmWithholding()">OK</button>
        </div>
      </div>

      <!-- Step 15: 従業員確認（法人） -->
      <div class="step" id="step15-employee">
        <div class="question">従業員はいますか？</div>
        <div class="btn-group">
          <div class="btn-group-top">
            <button class="btn btn-primary" onclick="handleEmployee(true)">はい</button>
            <button class="btn btn-secondary" onclick="handleEmployee(false)">いいえ</button>
          </div>
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
        </div>
      </div>

      <!-- Step 16-A: 給与オプション（個人事業主のみ） -->
      <div class="step" id="step16-salary-check">
        <div class="question">給与オプションについて（副業や別途給与の支給がある方）</div>

        <div class="warning-box" style="margin-top:12px;">
          <strong>注意点：</strong><br>
          会社員で別途今回とは別に給与の支給のある方。<br>
          副業等の方ですか？
        </div>

        <div class="option-card info-only" style="margin-top:12px;">
          <div class="option-text"><strong>給与所得とは？</strong></div>
          <div class="info-btn" onclick="showInfo(this)">?</div>
          <div class="info-tooltip">
            <h4>給与所得とは？</h4>
            <p>勤務先から受け取る給与・賞与等の所得のことです。</p>
          </div>
        </div>

        <div class="btn-group">
          <div class="btn-group-top">
            <button class="btn btn-primary" type="button" onclick="handleSalaryIncome(true)">はい</button>
            <button class="btn btn-secondary" type="button" onclick="handleSalaryIncome(false)">いいえ</button>
          </div>
          <button class="btn btn-back" type="button" onclick="goBack()">前に戻る</button>
        </div>
      </div>

      <!-- Step 16: 最終確認項目 -->
      <div class="step" id="step16-final-check">
        <div class="question">最終確認項目</div>
        <div class="warning-box">
          <strong>▼【最重要】お申し込みと資料提出の期限について</strong><br>
          正確な決算・申告のため、以下の期限を厳守ください。
        </div>

        <div class="option-card">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="final1">
            <label for="final1">前期及び当期のの売上高（年商）が1,000万円以下です。<br>
              <small style="color:#6B7280;">※超過の場合、超過料金として10万円を頂戴します。</small>
            </label>
          </div>
        </div>

        <div id="entitySpecificChecks"></div>

        <div class="option-card">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="final7">
            <label for="final7">法定調書・年末調整はオプションです。（不要の方もチェックを入れてください）<br>
              <small style="color:#6B7280;">当年分の対応は<strong><span style="color:#EF4444;">11月末までのお申し込み</span></strong>に限ります。オプションを外した場合はご自身での対応となります。</small>
            </label>
          </div>
        </div>

        <!-- e-Tax/eLTAX取得確認 -->
        <div class="option-card">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="final6">
            <label for="final6">e-Tax、eLTAXを取得している。（個人はe-Taxのみ、法人は両方必要）<br>
              <small style="color:#6B7280;">※電子申告に必要なIDです。未取得の場合はご自身で取得いただく必要があります。</small>
            </label>
          </div>
          <div class="info-btn" onclick="showInfo(this)">?</div>
          <div class="info-tooltip">
            <h4>e-Tax・eLTAXとは？</h4>
            <p style="white-space:pre-line;">
<strong>e-Tax（イータックス）</strong><br>
国税（所得税・法人税・消費税など）の電子申告システムです。<br>
国税庁のウェブサイトから利用者識別番号を取得できます。<br>
<br>
<strong>eLTAX（エルタックス）</strong><br>
地方税（住民税・事業税など）の電子申告システムです。<br>
法人の場合は両方必要になります。<br>
eLTAXのウェブサイトから利用者IDを取得できます。
            </p>
          </div>
        </div>

        <!-- サービス範囲の詳細を❓に格納 -->
        <div class="option-card">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="final5">
            <label for="final5">サービス範囲外の業務について理解しました<br>
              <small style="color:#6B7280;">経理、労務手続き、登記、許認可の申請、法務についてはご対応できません。<br>（詳細は「？」をご確認ください）</small>
            </label>
          </div>
          <div class="info-btn" onclick="showInfo(this)">?</div>
          <div class="info-tooltip">
            <h4>サービス範囲外となる業務（ご契約いただいても対応できません）</h4>
            <p style="white-space:pre-line;">
【理由】税理士法やその他の法律で定められた専門領域外となるため。<br>
・経理のまるなげ代行：× 請求書の発行、売掛金の回収管理、経費の振込、給与振込 など<br>
・労務手続き（社会保険労務士の領域）：× 社会保険の加入手続き、助成金の申請、就業規則の作成 など<br>
・登記手続き（司法書士の領域）：× 会社設立登記、役員変更登記 など<br>
・許認可の申請（行政書士の領域）：× 建設業や飲食店の営業許可申請 など<br>
・法務（弁護士の領域）：× 契約書の作成やリーガルチェック など<br>
            </p>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
          <button class="btn btn-primary" onclick="proceedToFinal()">確認完了</button>
        </div>
      </div>

      <!-- Step 17: 最終オプション -->
      <div class="step" id="step17-final">
        <div class="question">プランと追加オプションを選択してください</div>
        <div class="price-plans" id="pricePlans"></div>
        <div class="final-options" id="finalOptions"></div>
        <div class="price-summary">
          <h2>料金概算</h2>
          <div id="priceSummary"></div>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-back" onclick="goBack()">前に戻る</button>
          <button class="btn btn-primary" onclick="submitApplication()">申込を完了する</button>
        </div>
      </div>

      <!-- エラー画面 -->
      <div class="step" id="step-error">
        <div class="error-box">
          <h3>申し訳ございません</h3>
          <p id="errorMessage">弊社ではお受けできません。</p>
        </div>
        <div class="warning-box" style="margin:20px auto;max-width:500px;">
          <strong>⚠️ ご注意</strong><br>
          前の画面に戻って回答を変更される場合は、正確な情報をご入力ください。虚偽の申告は利用規約違反となります。
        </div>
        <div class="btn-group">
          <div class="btn-group-top">
            <button class="btn btn-back" onclick="goBackWithWarning()">一つ前に戻る</button>
            <button class="btn btn-secondary" onclick="restart()">最初から始める</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== GAS Web App URL (v47 - 医療費控除追加・CJ列拡張・BO列形式変更) ==========
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbx0FlBY4gw_9_DRKGB8Bi-v4dJcs7o_gJqgD3I6StJ_IH4MuwCEwa-BEk8ViUlppc76/exec'; // v47 (医療費控除追加・CJ列拡張・BO列形式変更)

    const appState = {
      currentStep: 0, stepHistory: [],
      entityType: null, declarationType: null,
      hasInvoice: false, invoiceNumber: null,
      industries: [], hasTaxObligation: false,
      selectedPlan: null, selectedOptions: {},
      totalPrice: 0, basePrice: 0,
      hasDependent: false, hasDirector: false,
      isYearEndPeriod: false, hasSalaryIncome: false,
      fromEmployeeWithholding: false
    };

    function checkContractPeriod() {
      const month = new Date().getMonth();
      appState.isYearEndPeriod = (month === 11);
      return !appState.isYearEndPeriod;
    }
    function updateProgress(){}

    function showStep(id){
      document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      appState.currentStep++; updateProgress();
      if(id==='step16-final-check'){ renderEntitySpecificChecks(); }
    }
    function goBack(){
      if(appState.stepHistory.length>0){
        const prev = appState.stepHistory.pop();
        document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
        document.getElementById(prev).classList.add('active');
        appState.currentStep--; updateProgress();
      }
    }
    function goBackWithWarning(){
      if(confirm('前の画面に戻りますが、正確な情報を入力してください。\n虚偽の申告は利用規約違反となります。\n\n前の画面に戻りますか？')) goBack();
    }
    function showInfo(btn){
      const tip = btn.nextElementSibling;
      document.querySelectorAll('.info-tooltip').forEach(t=>{ if(t!==tip) t.classList.remove('show');});
      tip.classList.toggle('show');
    }
    document.addEventListener('click',e=>{
      if(!e.target.closest('.info-btn')) document.querySelectorAll('.info-tooltip').forEach(t=>t.classList.remove('show'));
    });

    function acceptTerms(){ appState.stepHistory.push('step0'); showStep('step1'); }
    function selectEntity(t){ appState.entityType=t; appState.stepHistory.push('step1'); showStep('step2'); }

    function handleCancellation(has){
      if(has){
        document.getElementById('errorMessage').textContent =
          appState.entityType==='individual' ? '過去に青色申告の取り消しがある場合、弊社ではお受けできません。' : '弊社ではお受け出来ません。';
        showStep('step-error');
      }else{
        appState.stepHistory.push('step2');
        if(appState.entityType==='individual') showStep('step3-individual');
        else showStep('step3-corporate-check');
      }
    }

    // 法人: 青色申告有無
    function handleCorporateBlueStatus(hasBlue){
      appState.stepHistory.push('step3-corporate-check');
      if(hasBlue) showStep('step3-corporate');
      else { appState.declarationType='white'; showDeclarationTypeAndProceed(); }
    }

    // 個人: 青色申告有無
    function handleBlueStatus(hasBlue){
      appState.stepHistory.push('step3-individual');
      if(hasBlue) showStep('step4-individual');
      else { appState.declarationType='white'; showDeclarationTypeAndProceed(); }
    }

    function handleBeforeYear(ok){
      appState.stepHistory.push('step4-individual');
      if(ok){ appState.declarationType='blue'; showDeclarationTypeAndProceed(); }
      else showStep('step5-individual');
    }
    function handleOpeningNotice(ok){
      appState.stepHistory.push('step5-individual');
      if(ok) showStep('step6-individual'); else showStep('step7-white');
    }
    function handleTwoMonths(ok){
      appState.stepHistory.push('step6-individual');
      if(ok){ appState.declarationType='blue'; showDeclarationTypeAndProceed(); }
      else showStep('step7-white');
    }
    function confirmWhiteReturn(){
      if(!document.getElementById('confirmWhite').checked){ alert('チェックを入れてください。'); return; }
      appState.declarationType='white';
      appState.stepHistory.push('step7-white'); showDeclarationTypeAndProceed();
    }

    // 法人: 日付判定
    function checkCorporateDates(){
      const e = document.getElementById('establishDate').value;
      const s = document.getElementById('submitDate').value;
      const c = document.getElementById('closingDate').value;
      if(!e||!s||!c){ alert('すべての日付を入力してください。'); return; }
      const result = checkAoiroStatus(e,s,c);
      appState.declarationType = result==='青色' ? 'blue' : 'white';
      if(result==='白色'){
        if(!confirm('青色申告ができず白色申告となる可能性がありますが、申告しますか？')){ showStep('step-error'); return; }
      }
      appState.stepHistory.push('step3-corporate');
      showDeclarationTypeAndProceed();
    }
    function checkAoiroStatus(establishmentDateStr, applicationDateStr, fiscalEndDateStr){
      const establishmentDate=new Date(establishmentDateStr+'T00:00:00');
      const applicationDate=new Date(applicationDateStr+'T00:00:00');
      const fiscalEndDate=new Date(fiscalEndDateStr+'T00:00:00');
      let firstTermYear;
      if(establishmentDate.getMonth()<=fiscalEndDate.getMonth()) firstTermYear=establishmentDate.getFullYear();
      else firstTermYear=establishmentDate.getFullYear()+1;
      const firstFiscalEndDate=new Date(firstTermYear,fiscalEndDate.getMonth()+1,0);
      const isFirstTerm=(fiscalEndDate.getTime()===firstFiscalEndDate.getTime());
      let deadline;
      if(isFirstTerm){
        const a=new Date(establishmentDate.getTime()); a.setMonth(a.getMonth()+3);
        const b=firstFiscalEndDate;
        deadline = (a.getTime()<b.getTime()) ? new Date(a.getTime()) : new Date(b.getTime());
        deadline.setDate(deadline.getDate()-1);
      }else{
        const termStartDate=new Date(fiscalEndDate.getFullYear(),fiscalEndDate.getMonth()-11,1);
        deadline=new Date(termStartDate.getTime()); deadline.setDate(deadline.getDate()-1);
      }
      return applicationDate.getTime()<=deadline.getTime() ? "青色" : "白色";
    }

    // インボイス
    function handleInvoice(has){
      appState.hasInvoice = has;
      appState.stepHistory.push('step8-invoice');
      if(has) showStep('step9-invoice-number');
      else if(appState.entityType==='individual') showStep('step10-tax-conditions');
      else showStep('step11-industry');
    }
    function submitInvoiceNumber(){
      const number=document.getElementById('invoiceNumber').value;
      if(!number||!number.match(/^[0-9]{13}$/)){ alert('正しいインボイス番号を入力してください（13桁の数字）'); return; }
      appState.invoiceNumber='T'+number;
      appState.hasTaxObligation=true;
      appState.stepHistory.push('step9-invoice-number');
      showStep('step11-industry');
    }

    // 消費税条件
    function checkTaxConditions(){
      const allChecked=['tax1','tax2','tax3','tax4'].every(id=>document.getElementById(id).checked);
      if(!allChecked){ document.getElementById('errorMessage').textContent='弊社ではお受け出来ません。'; showStep('step-error'); return; }
      appState.hasTaxObligation=false;
      appState.stepHistory.push('step10-tax-conditions');
      showStep('step11-industry');
    }

    // 業種
    function toggleIndustry(el,ind){ el.classList.toggle('selected'); const i=appState.industries.indexOf(ind); if(i>-1) appState.industries.splice(i,1); else appState.industries.push(ind); }
    function confirmIndustry(){
      if(appState.industries.length===0){ alert('少なくとも1つの業種を選択してください。'); return; }
      appState.stepHistory.push('step11-industry');
      if(appState.entityType==='individual') showStep('step12-dependent'); else showStep('step12-director');
    }

    // ▼▼ 専従者関連 ▼▼
    function handleDependent(has){
      appState.stepHistory.push('step12-dependent');
      appState.hasDependent = has;
      if (has) {
        if (appState.declarationType === 'blue') {
          showStep('step13-dependent-blue');
        } else {
          if (confirm('白色の専従者給与になります。よろしいですか？')) {
            showStep('step16-final-check');
          } else {
            document.getElementById('errorMessage').textContent = '弊社ではお取り扱いできません。';
            showStep('step-error');
          }
        }
      } else {
        showStep('step16-salary-check');
      }
    }
    function handleDependentNotice(has){
      appState.stepHistory.push('step13-dependent-blue');
      if(has){ showStep('step14-dependent-conditions'); }
      else{
        alert('青色の専従者給与としては認められません（白色扱い）。');
        showStep('step16-final-check');
      }
    }
    function confirmWhiteDependent(){
      if(!document.getElementById('confirmWhiteDependent').checked){
        alert('チェックを入れてください。'); return;
      }
      appState.stepHistory.push('step13-dependent-white-confirm');
      showStep('step16-final-check');
    }
    function rejectWhiteDependent(){
      document.getElementById('errorMessage').textContent='弊社ではお取り扱いできません。';
      showStep('step-error');
    }
    function checkDependentConditions(){
      const allChecked=['dep1','dep2','dep3','dep4','dep5'].every(id=>document.getElementById(id).checked);
      if(!allChecked){ alert('すべてチェックしてください。'); return; }
      appState.stepHistory.push('step14-dependent-conditions');
      showStep('step16-final-check');
    }
    // ▲▲ 専従者関連ここまで ▲▲

    // 役員報酬（法人）
    function handleDirector(has){
      appState.stepHistory.push('step12-director');
      appState.hasDirector=has;
      if(has) showStep('step13-director-conditions');
      else showStep('step15-employee');
    }
    function checkDirectorConditions(){
      const allChecked=['dir1','dir2','dir3'].every(id=>document.getElementById(id).checked);
      if(!allChecked){
        document.getElementById('errorMessage').textContent='弊社では、お受け出来ません。';
        showStep('step-error');
      }else{
        appState.stepHistory.push('step13-director-conditions');
        showStep('step16-final-check');
      }
    }

    // 従業員有無
    function handleEmployee(has){
      appState.stepHistory.push('step15-employee');
      if(has){
        appState.fromEmployeeWithholding = true;
        showStep('step14-withholding');
      }else{
        showStep('step16-final-check');
      }
    }
    function confirmWithholding(){
      const ok = document.getElementById('withholding1').checked;
      if(!ok){ alert('チェックを入れてください。'); return; }
      appState.stepHistory.push('step14-withholding');
      showStep('step17-final');
      renderPricePlans();
      renderFinalOptions();
    }

    /* エンティティ固有のチェック */
    function renderEntitySpecificChecks() {
      const container = document.getElementById('entitySpecificChecks');
      if (!container) return;

      if (appState.entityType === 'individual') {
        container.innerHTML = `
          <div class="option-card">
            <div class="checkbox-wrapper">
              <input type="checkbox" id="final2">
              <label for="final2">【個人事業主のお客様】<br>
              ご契約・資料提出期限： 申告対象年の翌年2月末日<br>
              <small style="color: #6B7280;">確定申告時期は大変混み合います。この日までに全ての資料が揃わない場合、期限内の申告をお約束することができません。</small></label>
            </div>
          </div>
        `;
      } else {
        container.innerHTML = `
          <div class="option-card">
            <div class="checkbox-wrapper">
              <input type="checkbox" id="final3">
              <label for="final3">【法人のお客様】ご契約期限： 決算月末日<br>
              <small style="color: #6B7280;">決算直前のご契約では、1年分の取引の確認が間に合わず、正確な申告が困難になるためです。</small></label>
            </div>
          </div>
          <div class="option-card">
            <div class="checkbox-wrapper">
              <input type="checkbox" id="final4">
              <label for="final4">【法人のお客様】資料提出期限： 決算日から14日以内<br>
              <small style="color: #6B7280;">決算日から14日過ぎたものについては、期限内申告ができない場合がございます。</small></label>
            </div>
          </div>
        `;
      }
      // ※ 給与ソフト注意は最終オプションに移動
    }

    // 価格プラン
    function renderPricePlans(){
      const c=document.getElementById('pricePlans');
      const hasTax=appState.hasTaxObligation;
      let yearlyTotal, monthlyPrice;
      if(hasTax){ yearlyTotal=128880; monthlyPrice=12300; }
      else { yearlyTotal=99080; monthlyPrice=9800; }
      const yearlyMonthly=Math.floor(yearlyTotal/12);
      c.innerHTML=`
        <div class="plan-card" onclick="selectPlan('yearly', ${yearlyTotal})">
          <h3>年間一括払いプラン</h3>
          <div class="plan-price">¥${yearlyMonthly.toLocaleString()} <small>/月</small></div>
          <div class="plan-total">年間総支払い ¥${yearlyTotal.toLocaleString()}</div>
        </div>
        <div class="plan-card" onclick="selectPlan('monthly', ${monthlyPrice})">
          <h3>月額払いプラン</h3>
          <div class="plan-price">¥${monthlyPrice.toLocaleString()} <small>/月</small></div>
          <div class="plan-total">年間総支払い ¥${(monthlyPrice*12).toLocaleString()}</div>
        </div>`;
    }
    function selectPlan(planType, amount){
      document.querySelectorAll('.plan-card').forEach(c=>c.classList.remove('selected'));
      event.currentTarget.classList.add('selected');
      appState.selectedPlan=planType;
      appState.basePrice = planType==='yearly' ? amount : amount*12;
      updatePriceSummary();
    }

    // 最終オプション
    function renderFinalOptions(){
      const container=document.getElementById('finalOptions');
      checkContractPeriod();
      let html='<h3>追加オプション</h3>';

      // 給与ソフト必須の注意（法人 or 個人で専従者あり）
      const needsPayrollNotice =
        (appState.entityType === 'corporate') ||
        (appState.entityType === 'individual' && appState.hasDependent);
      if (needsPayrollNotice) {
        html += `
          <div class="option-card info-only" style="margin-top:12px; border-color:#F59E0B; background:#FFFBEB;">
            <div class="option-text">
              <div>
                <strong style="color:#92400E;">freee人事労務もしくは、マネーフォワード給与のご登録・お支払いが必ず必要となります。</strong><br>
                <small style="color:#6B7280; line-height:1.7;">
                  こちらは<strong>会計ソフトとは別</strong>のもので、<strong>必ずご契約が必要</strong>です。<br>
                  ・freeeの場合：<strong>2,600 円〜/月</strong><br>
                  ・マネーフォワードの場合：<strong>3,980 円〜/月</strong><br>
                  こちらにつきましては、<strong>別途決済後リンク</strong>をお送りいたします。
                </small>
              </div>
            </div>
          </div>
        `;
      }

      if(appState.isYearEndPeriod && (appState.hasDependent || appState.hasDirector)){
        html+=`
          <div class="warning-box">
            <strong>⚠️ 重要なお知らせ</strong><br>
            12月のご契約のため、法定調書・年末調整・源泉徴収のオプションはご利用いただけません。<br>
            ご自身での対応が必要となります。<br><br>
            前年度の法定調書・年末調整・源泉徴収を翌年契約では対応できません。<br>
            必要な場合は当年度の11月末までのご契約をお願いいたします。
          </div>`;
      }

      if(appState.entityType==='individual'){
        let yearEndDisabled='', yearEndMessage='';
        if(appState.isYearEndPeriod && appState.hasDependent){ yearEndDisabled='disabled'; yearEndMessage='（12月契約のため選択不可）'; }

        html+=`
          <div class="option-card"><div class="checkbox-wrapper">
            <input type="checkbox" id="opt-salary" onchange="updatePriceSummary()" ${appState.hasSalaryIncome?'checked':''}>
            <label for="opt-salary">給与所得（会社員等・副業）（¥5,000）</label></div>
            <div class="info-btn" onclick="showInfo(this)">?</div>
            <div class="info-tooltip"><h4>給与所得</h4><p>勤務先から受け取る給与</p></div>
          </div>

          <div class="option-card"><div class="checkbox-wrapper">
            <input type="checkbox" id="opt-realestate" onchange="updatePriceSummary()">
            <label for="opt-realestate">不動産所得（¥50,000）※3件/3部屋まで</label></div>
            <div class="info-btn" onclick="showInfo(this)">?</div>
            <div class="info-tooltip"><h4>不動産所得</h4><p>賃貸物件の家賃収入</p></div>
          </div>

          <div class="option-card"><div class="checkbox-wrapper">
            <input type="checkbox" id="opt-furusato" onchange="updatePriceSummary()">
            <label for="opt-furusato">ふるさと納税（¥5,000）</label></div>
            <div class="info-btn" onclick="showInfo(this)">?</div>
            <div class="info-tooltip"><h4>ふるさと納税</h4><p>確定申告時は書類が必要</p></div>
          </div>

          <div class="option-card">
            <div class="checkbox-wrapper">
              <input type="checkbox" id="opt-mortgage" onchange="updatePriceSummary()">
              <label for="opt-mortgage">住宅ローン控除の申請（初年度不可）2年目以降から（¥20,000）</label>
            </div>
            <div class="info-btn" onclick="showInfo(this)">?</div>
            <div class="info-tooltip"><h4>住宅ローン控除（2年目以降）</h4><p>初年度は原則として税務署/住宅取得時の手続きが必要です。</p></div>
          </div>

          <div class="option-card"><div class="checkbox-wrapper">
            <input type="checkbox" id="opt-medical" onchange="updatePriceSummary()">
            <label for="opt-medical">医療費控除（¥10,000）</label></div>
            <div class="info-btn" onclick="showInfo(this)">?</div>
            <div class="info-tooltip"><h4>医療費控除</h4><p>年間の医療費が一定額を超えた場合に適用される控除です。</p></div>
          </div>`;

        if(appState.hasDependent){
          html+=`
            <div class="option-card ${yearEndDisabled}">
              <div class="checkbox-wrapper">
                <input type="checkbox" id="opt-yearend-personal" onchange="updatePriceSummary()" ${yearEndDisabled} ${(appState.hasDependent && !appState.isYearEndPeriod)?'checked':''}>
                <label for="opt-yearend-personal">法定調書・年末調整セット（¥20,000）※5人まで${yearEndMessage}</label>
              </div>
              <div class="info-btn" onclick="showInfo(this)">?</div>
              <div class="info-tooltip"><h4>法定調書・年末調整</h4><p>専従者給与がある場合に必要です。</p></div>
            </div>

            <div class="option-card ${yearEndDisabled}">
              <div class="checkbox-wrapper">
                <input type="checkbox" id="opt-withholding-personal" onchange="updatePriceSummary()" ${yearEndDisabled} ${(appState.hasDependent && !appState.isYearEndPeriod)?'checked':''}>
                <label for="opt-withholding-personal">源泉納付書 - 特例（¥6,000）${yearEndMessage}</label>
              </div>
              <div class="info-btn" onclick="showInfo(this)">?</div>
              <div class="info-tooltip"><h4>特例</h4><p>年2回納付の特例制度</p></div>
            </div>`;
        }

        html+=`
          <div class="option-card"><div class="checkbox-wrapper">
            <input type="checkbox" id="opt-fx" onchange="toggleFxInput()">
            <label for="opt-fx">FXによる所得（¥50,000〜）</label></div>
            <div class="option-with-input" id="fx-input" style="display:none;">
              <input type="number" id="fx-millions" min="0" value="0" onchange="updatePriceSummary()"><span>千万円</span>
            </div>
          </div>

          <div class="option-card"><div class="checkbox-wrapper">
            <input type="checkbox" id="opt-crypto" onchange="toggleCryptoInput()">
            <label for="opt-crypto">暗号資産の取引（¥100,000〜）</label></div>
            <div class="option-with-input" id="crypto-input" style="display:none;">
              <input type="number" id="crypto-millions" min="0" value="0" onchange="updatePriceSummary()"><span>千万円</span>
            </div>
          </div>`;
      }else{
        let yearEndDisabled='', yearEndMessage='';
        if(appState.isYearEndPeriod && appState.hasDirector){ yearEndDisabled='disabled'; yearEndMessage='（12月契約のため選択不可）'; }

        html+=`
          <div class="option-card ${yearEndDisabled}">
            <div class="checkbox-wrapper">
              <input type="checkbox" id="opt-yearend" onchange="updatePriceSummary()" ${yearEndDisabled} ${(appState.hasDirector && !appState.isYearEndPeriod)?'checked':''}>
              <label for="opt-yearend">法定調書・年末調整セット（¥20,000）※5人まで${yearEndMessage}</label>
            </div>
            <div class="info-btn" onclick="showInfo(this)">?</div>
            <div class="info-tooltip"><h4>法定調書・年末調整</h4><p>税務申告に必要な書類です。</p></div>
          </div>

          <div class="option-card ${yearEndDisabled}">
            <div class="checkbox-wrapper">
              <input type="checkbox" id="opt-withholding-special" onchange="updatePriceSummary()" ${yearEndDisabled} ${(!appState.isYearEndPeriod)?'checked':''}>
              <label for="opt-withholding-special">源泉納付書 - 特例（¥6,000）${yearEndMessage}</label>
            </div>
            <div class="info-btn" onclick="showInfo(this)">?</div>
            <div class="info-tooltip"><h4>特例</h4><p>年2回の納付で済む制度</p></div>
          </div>

          <div class="option-card">
            <div class="checkbox-wrapper">
              <input type="checkbox" id="opt-withholding-normal" onchange="updatePriceSummary()">
              <label for="opt-withholding-normal">源泉納付書 - 普通（¥36,000）</label>
            </div>
            <div class="info-btn" onclick="showInfo(this)">?</div>
            <div class="info-tooltip"><h4>普通</h4><p>毎月納付が必要な通常の源泉徴収</p></div>
          </div>

          <div class="option-card">
            <div class="checkbox-wrapper">
              <input type="checkbox" id="opt-fx-corp" onchange="toggleFxInputCorp()">
              <label for="opt-fx-corp">FXによる所得（¥50,000〜）</label>
            </div>
            <div class="option-with-input" id="fx-input-corp" style="display:none;">
              <input type="number" id="fx-millions-corp" min="0" value="0" onchange="updatePriceSummary()"><span>千万円</span>
            </div>
          </div>

          <div class="option-card">
            <div class="checkbox-wrapper">
              <input type="checkbox" id="opt-crypto-corp" onchange="toggleCryptoInputCorp()">
              <label for="opt-crypto-corp">暗号資産の取引（¥100,000〜）</label>
            </div>
            <div class="option-with-input" id="crypto-input-corp" style="display:none;">
              <input type="number" id="crypto-millions-corp" min="0" value="0" onchange="updatePriceSummary()"><span>千万円</span>
            </div>
          </div>`;
      }

      if(!appState.isYearEndPeriod && (appState.hasDependent || appState.hasDirector)){
        html+=`
          <div class="success-box" style="margin-top:20px;">
            <strong>✅ 自動追加されたオプション</strong><br>
            ${appState.entityType === 'individual'
              ? '専従者給与があるため、法定調書・年末調整・源泉（特例）が組み込まれています。'
              : '役員報酬があるため、法定調書・年末調整・源泉（特例）が組み込まれています。'}
          </div>`;
      }
      if(appState.entityType==='individual' && appState.hasSalaryIncome){
        html+=`
          <div class="success-box" style="margin-top:20px;">
            <strong>✅ 給与所得オプション自動追加</strong><br>
            給与所得があるため、給与所得オプション（¥5,000）が自動追加されています。
          </div>`;
      }

      container.innerHTML = html;
      setTimeout(()=>updatePriceSummary(),100);
    }

    function toggleFxInput(){ const el=document.getElementById('fx-input'); el.style.display=document.getElementById('opt-fx').checked?'flex':'none'; updatePriceSummary(); }
    function toggleCryptoInput(){ const el=document.getElementById('crypto-input'); el.style.display=document.getElementById('opt-crypto').checked?'flex':'none'; updatePriceSummary(); }
    function toggleFxInputCorp(){ const el=document.getElementById('fx-input-corp'); el.style.display=document.getElementById('opt-fx-corp').checked?'flex':'none'; updatePriceSummary(); }
    function toggleCryptoInputCorp(){ const el=document.getElementById('crypto-input-corp'); el.style.display=document.getElementById('opt-crypto-corp').checked?'flex':'none'; updatePriceSummary(); }

    function updatePriceSummary(){
      if(!appState.selectedPlan){
        document.getElementById('priceSummary').innerHTML='<p style="text-align:center;color:#6B7280;">プランを選択してください</p>'; return;
      }
      let optionsTotal=0; const items=[];
      items.push({name: appState.selectedPlan==='yearly'?'年間一括払いプラン':'月額払いプラン', price: appState.basePrice});

      if(appState.entityType==='individual'){
        if(document.getElementById('opt-salary')?.checked){ optionsTotal+=5000; items.push({name:'給与所得',price:5000}); }
        if(document.getElementById('opt-realestate')?.checked){ optionsTotal+=50000; items.push({name:'不動産所得',price:50000}); }
        if(document.getElementById('opt-furusato')?.checked){ optionsTotal+=5000; items.push({name:'ふるさと納税',price:5000}); }
        if(document.getElementById('opt-mortgage')?.checked){ optionsTotal+=20000; items.push({name:'住宅ローン控除（2年目以降）', price:20000}); }
        if(document.getElementById('opt-medical')?.checked){ optionsTotal+=10000; items.push({name:'医療費控除',price:10000}); }
        if(document.getElementById('opt-yearend-personal')?.checked){ optionsTotal+=20000; items.push({name:'法定調書・年末調整セット',price:20000}); }
        if(document.getElementById('opt-withholding-personal')?.checked){ optionsTotal+=6000; items.push({name:'源泉納付書（特例）',price:6000}); }
        if(document.getElementById('opt-fx')?.checked){
          const m=parseInt(document.getElementById('fx-millions').value)||0; const p=50000+(m*50000); optionsTotal+=p; items.push({name:`FXによる所得（${m}千万円）`,price:p});
        }
        if(document.getElementById('opt-crypto')?.checked){
          const m=parseInt(document.getElementById('crypto-millions').value)||0; const p=100000+(m*100000); optionsTotal+=p; items.push({name:`暗号資産の取引（${m}千万円）`,price:p});
        }
      }else{
        if(document.getElementById('opt-yearend')?.checked){ optionsTotal+=20000; items.push({name:'法定調書・年末調整セット',price:20000}); }
        if(document.getElementById('opt-withholding-special')?.checked){ optionsTotal+=6000; items.push({name:'源泉納付書（特例）',price:6000}); }
        if(document.getElementById('opt-withholding-normal')?.checked){ optionsTotal+=36000; items.push({name:'源泉納付書（普通）',price:36000}); }
        if(document.getElementById('opt-fx-corp')?.checked){
          const m = parseInt(document.getElementById('fx-millions-corp').value) || 0;
          const p = 50000 + (m * 50000);
          optionsTotal += p;
          items.push({name:`FXによる所得（${m}千万円）`, price:p});
        }
        if(document.getElementById('opt-crypto-corp')?.checked){
          const m = parseInt(document.getElementById('crypto-millions-corp').value) || 0;
          const p = 100000 + (m * 100000);
          optionsTotal += p;
          items.push({name:`暗号資産の取引（${m}千万円）`, price:p});
        }
      }

      let html='';
      items.forEach(i=>{ html+=`<div class="price-item"><span>${i.name}</span><span>¥${i.price.toLocaleString()}</span></div>`; });

      if(optionsTotal>0){
        html+=`<div class="price-item"><span>追加オプション</span><span>¥${optionsTotal.toLocaleString()}</span></div>`;
      }
      const total=appState.basePrice+optionsTotal;
      html+=`<div class="price-item"><span>初年度合計金額</span><span>¥${total.toLocaleString()}</span></div>`;
      html+='<p style="margin-top:15px;font-size:12px;color:#6B7280;">※オプション料金は毎年継続してお支払いとなります</p>';

      if(appState.isYearEndPeriod && (appState.hasDependent || appState.hasDirector)){
        html+=`
          <div class="warning-box" style="margin-top:15px;">
            <strong>⚠️ ご注意</strong><br>
            前年度の法定調書・年末調整・源泉徴収を翌年契約では対応できません。必要な場合は当年度の11月末までのご契約が必要です。
          </div>`;
      }

      document.getElementById('priceSummary').innerHTML=html;
      appState.totalPrice=total;
    }

    function showDeclarationTypeAndProceed(){
      const msg = appState.declarationType==='blue' ? '✅ 青色申告で進みます。' : '⚠️ 白色申告で進みます。';
      alert(msg);
      showStep('step8-invoice');
    }

    // 給与オプションから最終確認へ
    function handleSalaryIncome(has){
      try{
        appState.hasSalaryIncome=has;
        appState.stepHistory.push('step16-salary-check');
        showStep('step16-final-check');
      }catch(e){
        console.error(e);
        showStep('step16-final-check');
      }
    }

    // 最終確認 → 最終オプションへ
    function proceedToFinal(){
      const requiredIds = ['final1','final5','final7'];
      if(appState.entityType==='individual') requiredIds.push('final2');
      else requiredIds.push('final3','final4');
      if(document.getElementById('final6')) requiredIds.push('final6');

      const allChecked = requiredIds.every(id => {
        const el=document.getElementById(id);
        return el ? el.checked : true;
      });
      if(!allChecked){ alert('すべての確認項目にチェックを入れてください。'); return; }

      appState.stepHistory.push('step16-final-check');
      showStep('step17-final');
      renderPricePlans();
      renderFinalOptions();
    }

    function submitApplication(){
    if(!appState.selectedPlan){
      alert('プランを選択してください。');
      return;
    }

    const yn = (b)=> b ? 'あり' : 'なし';
    const establishDate = document.getElementById('establishDate')?.value || '';
    const submitDate    = document.getElementById('submitDate')?.value || '';
    const closingDate   = document.getElementById('closingDate')?.value || '';

    const opt = {
      realestate: document.getElementById('opt-realestate')?.checked || false,
      furusato:   document.getElementById('opt-furusato')?.checked   || false,
      mortgage:   document.getElementById('opt-mortgage')?.checked   || false,
      medical:    document.getElementById('opt-medical')?.checked    || false,
      yearendPersonal:     document.getElementById('opt-yearend-personal')?.checked || false,
      withholdingPersonal: document.getElementById('opt-withholding-personal')?.checked || false,
      yearend:            document.getElementById('opt-yearend')?.checked || false,
      withholdingSpecial: document.getElementById('opt-withholding-special')?.checked || false,
      withholdingNormal:  document.getElementById('opt-withholding-normal')?.checked  || false,
      fx: (document.getElementById('opt-fx')?.checked || document.getElementById('opt-fx-corp')?.checked) || false,
      fxAmount: (()=>{
        const v1 = document.getElementById('fx-millions')?.value;
        const v2 = document.getElementById('fx-millions-corp')?.value;
        return parseInt(v1 ?? v2 ?? '0') || 0;
      })(),
      crypto: (document.getElementById('opt-crypto')?.checked || document.getElementById('opt-crypto-corp')?.checked) || false,
      cryptoAmount: (()=>{
        const v1 = document.getElementById('crypto-millions')?.value;
        const v2 = document.getElementById('crypto-millions-corp')?.value;
        return parseInt(v1 ?? v2 ?? '0') || 0;
      })()
    };

    const industriesText = Array.isArray(appState.industries) ? appState.industries.join(', ') : (appState.industries || '');
    const hasYearendSet = opt.yearend || opt.yearendPersonal;
    const hasWithholdingSpecial = opt.withholdingSpecial || opt.withholdingPersonal;

    // === ここが重要：LP①のG〜AAのヘッダ名に一致する形でオブジェクト化 ===
    const record = {
      '個人・法人': (appState.entityType === 'corporate') ? '法人' : '個人',
      '青色・白色': (appState.declarationType === 'blue') ? '青色' : '白色',
      '設立日':          establishDate,
      '青色申告提出日':  submitDate,
      '次回決算日':      closingDate,
      'インボイス番号':  appState.invoiceNumber || '',
      '業種':            industriesText,
      '専従者給与の支払い': yn(!!appState.hasDependent),
      '役員報酬':          yn(!!appState.hasDirector),
      '給与所得':          yn(!!appState.hasSalaryIncome),
      '不動産所得':        yn(!!opt.realestate),
      'ふるさと納税':      yn(!!opt.furusato),
      '住宅ローン控除の申請': yn(!!opt.mortgage),
      '医療費控除':        yn(!!opt.medical),
      '法定調書・年末調整セット': yn(hasYearendSet),
      '源泉納付（特例）': yn(hasWithholdingSpecial),
      '源泉納付（普通）': yn(!!opt.withholdingNormal),
      'FX所得':           yn(!!opt.fx) + (opt.fx ? `（規模: ${opt.fxAmount}千万円）` : ''),
      '暗号資産の取引':   yn(!!opt.crypto) + (opt.crypto ? `（規模: ${opt.cryptoAmount}千万円）` : ''),
      'プラン':            (appState.selectedPlan === 'yearly') ? '年間一括払い' : '月額払い',
      '料金':              Number(appState.basePrice || 0),
      '初年度合計金額':    Number(appState.totalPrice || 0)
    };

    // 表示（任意）
    const text = Object.entries(record)
      .map(([k,v]) => `${k}：${(typeof v === 'number') ? `¥${v.toLocaleString()}` : v}`)
      .join('\n');
    if (!confirm('申込内容（LP①）を保存します。\n\n' + text + '\n\nよろしければOKを押してください。')) {
      return;
    }

    // === オプション料金配列を構築 ===
    const options = [];
    
    // 給与所得
    if (appState.hasSalaryIncome || (document.getElementById('opt-salary')?.checked)) {
      options.push({ name: '給与所得オプション', amount: 5000 });
    }
    
    // 不動産所得
    if (opt.realestate) {
      options.push({ name: '不動産所得オプション', amount: 50000 });
    }
    
    // ふるさと納税
    if (opt.furusato) {
      options.push({ name: 'ふるさと納税オプション', amount: 5000 });
    }
    
    // 住宅ローン控除
    if (opt.mortgage) {
      options.push({ name: '住宅ローン控除（2年目以降）', amount: 20000 });
    }
    
    // 医療費控除
    if (opt.medical) {
      options.push({ name: '医療費控除', amount: 10000 });
    }
    
    // 法定調書・年末調整
    if (hasYearendSet) {
      options.push({ name: '法定調書・年末調整セット', amount: 20000 });
    }
    
    // 源泉納付（特例）
    if (hasWithholdingSpecial) {
      options.push({ name: '源泉納付書（特例）', amount: 6000 });
    }
    
    // 源泉納付（普通）
    if (opt.withholdingNormal) {
      options.push({ name: '源泉納付書（普通）', amount: 36000 });
    }
    
    // FX所得
    if (opt.fx) {
      const fxPrice = 50000 + (opt.fxAmount * 50000);
      options.push({ name: `FXによる所得（${opt.fxAmount}千万円）`, amount: fxPrice });
    }
    
    // 暗号資産
    if (opt.crypto) {
      const cryptoPrice = 100000 + (opt.cryptoAmount * 100000);
      options.push({ name: `暗号資産の取引（${opt.cryptoAmount}千万円）`, amount: cryptoPrice });
    }

    // === 決済データ構築 ===
    const payment = {
      hasTaxObligation: appState.hasTaxObligation,
      planType: appState.selectedPlan,  // 'yearly' or 'monthly'
      entityType: appState.entityType,   // 'individual' or 'corporate'
      basePrice: appState.basePrice,
      options: options,
      totalPrice: appState.totalPrice
    };

    // === LP①データ保存 + Stripe Checkout作成 ===
    const params = new URLSearchParams();
    params.append('action', 'saveLP1AndCreateCheckout');
    params.append('record', JSON.stringify(record));
    params.append('payment', JSON.stringify(payment));
    
    // ローディング表示
    const submitBtn = event.target;
    submitBtn.disabled = true;
    submitBtn.textContent = '処理中...';
    
    fetch(GAS_API_URL, {
      method: 'POST',
      body: params
    })
    .then(res => res.json())
    .then(data => {
      if (!data || !data.success) {
        submitBtn.disabled = false;
        submitBtn.textContent = '申込を完了する';
        alert('保存に失敗しました。\n' + (data && data.error ? data.error : '不明なエラー'));
        return;
      }
      
      // Stripe Checkoutへリダイレクト
      if (data.checkoutUrl) {
        window.location.href = data.checkoutUrl;
      } else {
        submitBtn.disabled = false;
        submitBtn.textContent = '申込を完了する';
        alert('決済ページの作成に失敗しました。');
      }
    })
    .catch(err => {
      submitBtn.disabled = false;
      submitBtn.textContent = '申込を完了する';
      alert('通信エラーが発生しました。\n再度お試しください。\n\nエラー詳細：' + err);
    });
  }

  function restart(){
    location.reload();
  }

  // ========== ページ初期化処理 ==========
  window.addEventListener('DOMContentLoaded', function() {
    // URLパラメータをチェック
    const urlParams = new URLSearchParams(window.location.search);
    
    // 決済キャンセル時の処理
    if (urlParams.get('canceled') === 'true') {
      // エラー画面を表示
      document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
      const errorStep = document.getElementById('step-error');
      if (errorStep) {
        errorStep.classList.add('active');
        const errorMessage = document.getElementById('errorMessage');
        if (errorMessage) {
          errorMessage.textContent = '決済がキャンセルされました。\n再度お申し込みをご希望の場合は、最初からやり直してください。';
        }
      }
      
      // URLからパラメータを削除
      window.history.replaceState({}, document.title, window.location.pathname);
    }
  });
  </script>
</body>
</html>
